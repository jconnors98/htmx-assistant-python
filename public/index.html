<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TalentCentral Assistant</title>
  <link rel="stylesheet" href="App.css" />
  <script src="https://unpkg.com/htmx.org@1.9.5"></script>
</head>
<body>
  <div class="container">
    <h1>BCCA Assistant</h1>
    <p class="intro">Welcome to your central hub for building success in BC’s construction industry. As the voice of the British Columbia Construction Association (BCCA) and our trusted partners, we provide the connections, resources, and support you need to thrive. From advocacy and procurement to workforce solutions and membership services, we’re here to help you access opportunities, grow your career, and strengthen the construction community across the province.</p>

    <div id="chat-window">
      <div id="chat-box" class="chat-box">
        <div id="prompt-buttons" class="prompt-buttons"></div>
      </div>
    </div>

      <!-- Text-based chat -->
      <form
        id="chat-form"
        hx-post="/flask/ask"
        hx-target="#chat-box"
        hx-swap="beforeend"
        onsubmit="clearInputAfterSend()"
      >
        <div class="input-group">
            <textarea
              id="message"
              name="message"
              placeholder="Loading..."
              rows="1"
              required
              disabled
            ></textarea>
            <input type="hidden" id="mode" name="mode" />
            <button id="send-btn" type="submit" disabled>Send</button>
            <button type="button" onclick="clearChat()" class="secondary">Clear Chat</button>
        </div>
      </form>

      <button id="scroll-top" onclick="scrollToTop()">⬆ Top</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get("mode");
    const chatForm = document.getElementById("chat-form");

    document.addEventListener("htmx:beforeRequest", () => {
      const thinking = document.createElement("div");
      thinking.className = "chat-entry assistant thinking";
      thinking.innerHTML = `
        <div class="bubble">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>`;
      document.getElementById("chat-box").appendChild(thinking);
    });

    document.addEventListener("htmx:afterOnLoad", () => {
      const thinkingBubble = document.querySelector(".chat-entry.thinking");
      if (thinkingBubble) thinkingBubble.remove();
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
      if (!document.getElementById("message").disabled) document.getElementById("message").focus();
    });

    async function init() {
      if (!mode) {
        document.getElementById("message").placeholder = "Mode is required in the URL.";
        return;
      }
      document.getElementById("mode").value = mode;
      try {
        const res = await fetch(`/flask/modes/${encodeURIComponent(mode)}`);
        if (res.ok) {
          const data = await res.json();
          const prompts = data.prompts || [];
          let html = "";
          prompts.forEach(p => {
            html += `<button onclick="submitPrompt(this.textContent)">${p}</button>`;
          });
          document.getElementById("prompt-buttons").innerHTML = html;
        }
      } catch (err) {
        console.error("Failed to load prompts", err);
      }
      document.getElementById("message").disabled = false;
      document.getElementById("send-btn").disabled = false;
      document.getElementById("message").placeholder = `Ask about ${mode.toLowerCase()}...`;
      document.getElementById("message").focus();
    }

    document.addEventListener("DOMContentLoaded", init);

    // Submit a prompt
    function submitPrompt(text) {
      document.getElementById("message").value = text;
      const prompt = document.createElement("div");
      prompt.className = "chat-entry user";
      prompt.innerHTML = `<div class="bubble">${text}</div>`;
      document.getElementById("chat-box").appendChild(prompt);
      chatForm.requestSubmit();
      setTimeout(() => {
        document.getElementById("message").value = "";
      }, 20);
    }

    // Submit on Enter (no Shift)
    document.getElementById("message").addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        submitPrompt(document.getElementById("message").value.trim());
      }
    });

    // Clear chat and reset
    function clearChat() {
      document.querySelectorAll("#chat-box .chat-entry").forEach(el => el.remove());
      document.getElementById("message").value = "";
      document.getElementById("message").focus();
    }

    function scrollToTop() {
      document.getElementById("chat-box").scrollTop = 0;
    }

    function clearInputAfterSend() {
      setTimeout(() => {
        document.getElementById("message").value = "";
      }, 20);
    }
  </script>
</body>
</html>
