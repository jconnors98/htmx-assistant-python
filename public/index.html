<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TalentCentral Assistant</title>
  <link rel="stylesheet" href="App.css" />
  <script src="https://unpkg.com/htmx.org@1.9.5"></script>
</head>
<body>
  <div class="container">
    <h1>BCCA Assistant</h1>
    <p class="intro">Your one-stop destination for construction jobs and career support in BC. Whether you're just starting out, changing careers, or looking to grow in the construction industry, we connect you with job opportunities, training programs, and resources from the British Columbia Construction Association (BCCA) and its partners. Start here to explore the tools and support you need to build your future in construction.</p>

    <div id="chat-window">
      <div id="chat-box" class="chat-box">
          <div class="mode-buttons">
            <button onclick="selectMode('Advocacy')">Advocacy</button>
            <button onclick="selectMode('Procurement')">Procurement</button>
            <button onclick="selectMode('Workforce Solutions')">Workforce Solutions</button>
            <button onclick="selectMode('Membership')">Membership</button>
          </div>
        </div>
      </div>

      <!-- Text-based chat -->
      <form
        id="chat-form"
        hx-post="/flask/ask"
        hx-target="#chat-box"
        hx-swap="beforeend"
        onsubmit="clearInputAfterSend()"
      >
        <div class="input-group">
            <textarea
              id="message"
              name="message"
              placeholder="Select a mode to begin..."
              rows="1"
              required
              disabled
            ></textarea>
            <input type="hidden" id="mode" name="mode" />
            <button id="send-btn" type="submit" disabled>Send</button>
            <button type="button" onclick="clearChat()" class="secondary">Clear Chat</button>
        </div>
      </form>

      <button id="scroll-top" onclick="scrollToTop()">â¬† Top</button>
    </div>
  </div>

  <script>
    const chatInput = document.getElementById("message");
    const chatBox = document.getElementById("chat-box");
    const modeInput = document.getElementById("mode");
    const sendBtn = document.getElementById("send-btn");

    const modePrompts = {
      "Advocacy": [
        "What is BCCA doing to advance Prompt Payment legislation?",
        "How does BCCA support Skilled Workforce Development?",
        "What are BCCA's key industry policy priorities right now?",
        "How can I find BCCA's latest advocacy updates or briefings?",
        "What is Construction Month and how can I get involved?"
      ],
      "Procurement": [
        "What procurement best practices does BCCA advocate for?",
        "Where can I find BCCA's public sector procurement resources?",
        "How can I use BidCentral or BCCA's standard documents?",
        "What is BCCA doing to influence procurement practices in BC?"
      ],
      "Workforce Solutions": [
        "How can TalentCentral help me find construction jobs and training?",
        "Tell me about the Building Builders mentorship program.",
        "What programs does BCCA offer for integrating newcomers or equity-seeking groups?",
        "What programs and services does BCCA offer as support?",
        "What is the BCCA Benefits Program?"
      ],
      "Membership": [
        "Why should my company become a BCCA member?",
        "How do I join BCCA or a Regional Construction Association?",
        "What benefits do members receive?",
        "Where can I find BCCA's strategic plan or governance info?"
      ]
    };
    let currentMode = "";

    // Submit on Enter (no Shift)
    chatInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Enable chat input and send button when a mode is selected

    // Add typing indicator
    document.addEventListener("htmx:beforeRequest", () => {
      const thinking = document.createElement("div");
      thinking.className = "chat-entry assistant thinking";
      thinking.innerHTML = `
        <div class="bubble">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>`;
      chatBox.appendChild(thinking);
    });

    // Remove typing indicator + scroll
    document.addEventListener("htmx:afterOnLoad", () => {
      const thinkingBubble = document.querySelector(".chat-entry.thinking");
      if (thinkingBubble) thinkingBubble.remove();
      chatBox.scrollTop = chatBox.scrollHeight;
      if (!chatInput.disabled) chatInput.focus();
    });

    function selectMode(mode) {
      currentMode = mode;
      modeInput.value = mode;
      const prompts = modePrompts[mode] || [];
      let html = '<div class="prompt-buttons">';
      prompts.forEach(p => {
        const escaped = JSON.stringify(p);
        html += `<button onclick="submitPrompt(${escaped})">${p}</button>`;
      });
      html += '</div>';
      chatBox.innerHTML = html;
      chatInput.disabled = false;
      sendBtn.disabled = false;
      chatInput.placeholder = `Ask about ${mode.toLowerCase()}...`;
      chatInput.focus();
    }

    // Submit a prompt
    function submitPrompt(text) {
      chatInput.value = text;
      const prompt = document.createElement("div");
      prompt.className = "chat-entry user";
      prompt.innerHTML = `
        <div class="bubble">${text}</div>`;
      chatBox.appendChild(prompt);
      sendBtn.click();
      setTimeout(() => {
        chatInput.value = "";
      }, 20);
    }

    // Clear chat and reset
    function clearChat() {
        chatBox.innerHTML = `
          <div class="mode-buttons">
            <button onclick="selectMode('Advocacy')">Advocacy</button>
            <button onclick="selectMode('Procurement')">Procurement</button>
            <button onclick="selectMode('Workforce Solutions')">Workforce Solutions</button>
            <button onclick="selectMode('Membership')">Membership</button>
          </div>`;
        chatInput.value = "";
        chatInput.placeholder = "Select a mode to begin...";
        chatInput.disabled = true;
        sendBtn.disabled = true;
        modeInput.value = "";
        currentMode = "";
      }

    function scrollToTop() {
      chatBox.scrollTop = 0;
    }

    function clearInputAfterSend() {
      setTimeout(() => {
        chatInput.value = "";
      }, 20);
    }
  </script>
</body>
</html>
