<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TalentCentral Assistant</title>
  <link rel="stylesheet" href="App.css" />
  <script src="https://unpkg.com/htmx.org@1.9.5"></script>
</head>
<body>
  <div class="container">
    <h1>BCCA Assistant</h1>
    <p class="intro">Welcome to your central hub for building success in BC’s construction industry. As the voice of the British Columbia Construction Association (BCCA) and our trusted partners, we provide the connections, resources, and support you need to thrive. From advocacy and procurement to workforce solutions and membership services, we’re here to help you access opportunities, grow your career, and strengthen the construction community across the province.</p>

    <div id="chat-window">
      <div id="chat-box" class="chat-box">
          <div id="mode-buttons" class="mode-buttons">
          <button onclick="selectMode('Advocacy')">Advocacy</button>
          <button onclick="selectMode('Procurement')">Procurement</button>
          <button onclick="selectMode('Workforce Solutions')">Workforce Solutions</button>
          <button onclick="selectMode('Membership')">Membership</button>
        </div>
        <div id="prompt-buttons" class="prompt-buttons"></div>
      </div>
    </div>

      <!-- Text-based chat -->
      <form
        id="chat-form"
        hx-post="/flask/ask"
        hx-target="#chat-box"
        hx-swap="beforeend"
        onsubmit="clearInputAfterSend()"
      >
        <div class="input-group">
            <textarea
              id="message"
              name="message"
              placeholder="Select a mode to begin..."
              rows="1"
              required
              disabled
            ></textarea>
            <input type="hidden" id="mode" name="mode" />
            <button id="send-btn" type="submit" disabled>Send</button>
            <button type="button" onclick="clearChat()" class="secondary">Clear Chat</button>
        </div>
      </form>

      <button id="scroll-top" onclick="scrollToTop()">⬆ Top</button>
  </div>

  <script>

    const modePrompts = {
      "Advocacy": [
        "What is BCCA doing to advance Prompt Payment legislation?",
        "How does BCCA support Skilled Workforce Development?",
        "What are BCCA&#039;s key industry policy priorities right now?",
        "How can I find BCCA&#039;s latest advocacy updates or briefings?",
        "What is Construction Month and how can I get involved?"
      ],
      "Procurement": [
        "What procurement best practices does BCCA advocate for?",
        "Where can I find BCCA&#039;s public sector procurement resources?",
        "How can I use BidCentral to find projects in BC?",
        "What is BCCA doing to influence procurement practices in BC?"
      ],
      "Workforce Solutions": [
        "How can TalentCentral help me find construction jobs and training?",
        "Tell me about the Building Builders mentorship program.",
        "What programs does BCCA offer for integrating newcomers or equity-seeking groups?",
        "What programs and services does BCCA offer as support?",
        "What is the BCCA Benefits Program?"
      ],
      "Membership": [
        "Why should my company become a BCCA member?",
        "How do I join BCCA or a Regional Construction Association?",
        "What benefits do members receive?",
        "Where can I find BCCA&#039;s strategic plan or governance info?"
      ]
    };
    let currentMode = "";
    const chatForm = document.getElementById("chat-form");

    // Enable chat input and send button when a mode is selected

    // Add typing indicator
    document.addEventListener("htmx:beforeRequest", () => {
      const thinking = document.createElement("div");
      thinking.className = "chat-entry assistant thinking";
      thinking.innerHTML = `
        <div class="bubble">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>`;
      document.getElementById("chat-box").appendChild(thinking);
    });

    // Remove typing indicator + scroll
    document.addEventListener("htmx:afterOnLoad", () => {
      const thinkingBubble = document.querySelector(".chat-entry.thinking");
      if (thinkingBubble) thinkingBubble.remove();
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
      if (!document.getElementById("message").disabled) document.getElementById("message").focus();
    });

    function selectMode(mode) {
      currentMode = mode;
      document.getElementById("mode").value = mode;
      const prompts = modePrompts[mode];
      let html = "";
      prompts.forEach(p => {
        const escapedPrompt = p.replace("&#039;", "");
        html += `<button onclick=\"submitPrompt('${escapedPrompt}')\">${p}</button>`;
      });
      document.getElementById("prompt-buttons").innerHTML = html;

      document.querySelectorAll("#mode-buttons button").forEach(btn => {
        btn.classList.toggle("active", btn.textContent === mode);
      });
      document.getElementById("message").disabled = false;
      document.getElementById("send-btn").disabled = false;
      document.getElementById("message").placeholder = `Ask about ${mode.toLowerCase()}...`;
      document.getElementById("message").focus();
      document.getElementById("chat-box").scrollTop = 0;

    }

    // Submit a prompt
    function submitPrompt(text) {
      document.getElementById("message").value = text;
      const prompt = document.createElement("div");
      prompt.className = "chat-entry user";
      prompt.innerHTML = `
        <div class="bubble">${text}</div>`;
      document.getElementById("chat-box").appendChild(prompt);
      chatForm.requestSubmit();
      setTimeout(() => {
        document.getElementById("message").value = "";
      }, 20);
    }

    // Submit on Enter (no Shift)
    document.getElementById("message").addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        submitPrompt(document.getElementById("message").value.trim());
      }
    });

    // Clear chat and reset
    function clearChat() {
      document.getElementById("prompt-buttons").innerHTML = "";
      document.querySelectorAll("#chat-box .chat-entry").forEach(el => el.remove());
      document.querySelectorAll("#mode-buttons button").forEach(btn => btn.classList.remove("active"));
      document.getElementById("message").value = "";
      document.getElementById("message").placeholder = "Select a mode to begin...";
      document.getElementById("message").disabled = true;
      document.getElementById("send-btn").disabled = true;
      document.getElementById("mode").value = "";
      currentMode = "";
    }

    function scrollToTop() {
      document.getElementById("chat-box").scrollTop = 0;
    }

    function clearInputAfterSend() {
      setTimeout(() => {
        document.getElementById("message").value = "";
      }, 20);
    }
  </script>
</body>
</html>
