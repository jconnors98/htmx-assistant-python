<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Mode Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#82002d',
            'primary-light': '#a0003f',
            'primary-dark': '#6b0024',
            secondary: '#f8fafc',
            accent: '#e2e8f0'
          },
          boxShadow: {
            'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
            'medium': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
            'strong': '0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'pulse-soft': 'pulseSoft 2s infinite'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            pulseSoft: {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.8' }
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Drag and drop styles */
    .dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }
    
    .drop-indicator {
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
      border-radius: 1px;
      margin: 4px 16px;
      transition: opacity 0.2s ease;
    }
    
    [draggable="true"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    [draggable="true"]:active {
      cursor: grabbing;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-100">
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header Section -->
    <div class="bg-white rounded-2xl shadow-soft border border-gray-100 p-8 mb-8 animate-fade-in">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-gradient-to-br from-primary to-primary-light rounded-xl flex items-center justify-center shadow-medium">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </div>
            <div>
              <h1 class="text-3xl font-bold text-gray-900">Mode Editor</h1>
              <p class="text-gray-600 text-sm">Configure your AI assistant's behavior and preferences</p>
            </div>
          </div>
        </div>
        
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
          <div id="client-url-wrapper" class="text-right bg-gray-50 rounded-xl p-4 border border-gray-200 min-w-0 flex-1 sm:flex-none">
            <div class="text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">Live URL</div>
            <a id="client-url" class="text-sm text-primary hover:text-primary-light hover:underline break-all font-medium transition-colors duration-200"></a>
          </div>
          <a href="https://bcca.ai/flask/widget-demo.html" target="_blank" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium shadow-medium hover:shadow-strong transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            Embed On Site
          </a>
          <button id="back-to-admin" class="bg-gradient-to-r from-primary to-primary-light hover:from-primary-dark hover:to-primary text-white px-6 py-3 rounded-xl font-medium shadow-medium hover:shadow-strong transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Modes
          </button>
        </div>
      </div>
    </div>
    <!-- Mode Settings Section -->
    <section class="bg-white rounded-2xl shadow-soft border border-gray-100 p-8 mb-8 animate-slide-up">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900">Mode Settings</h2>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Basic Information -->
        <div class="space-y-6">
          <div class="space-y-4">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
              <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Basic Information
            </h3>
            
            <div class="space-y-4">
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Name of Site or Service</label>
                <input id="mode-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="Enter a unique name for your mode" />
              </div>
              
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Display Title</label>
                <input id="mode-title" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="Title shown to users" />
              </div>
              
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea id="mode-desc" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md resize-none overflow-hidden" placeholder="Describe what this mode does" style="min-height: 80px;"></textarea>
              </div>
              
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Introduction Message</label>
                <textarea id="mode-intro" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md resize-none overflow-hidden" placeholder="Message displayed above the chat interface" style="min-height: 80px;"></textarea>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Appearance & Branding -->
        <div class="space-y-6">
          <div class="space-y-4">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
              <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
              </svg>
              Appearance & Branding
            </h3>
            
            <div class="space-y-4">
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Primary Color</label>
                <div class="flex items-center gap-4">
                  <input id="mode-color" type="color" value="#82002d" class="h-12 w-16 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary cursor-pointer" />
                  <div class="flex-1">
                    <div class="text-sm text-gray-600">Choose your brand color</div>
                    <div class="text-xs text-gray-500">This color will be used for buttons and accents</div>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Text Color</label>
                <div class="flex items-center gap-4">
                  <input id="mode-text-color" type="color" value="#ffffff" class="h-12 w-16 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary cursor-pointer" />
                  <div class="flex-1">
                    <div class="text-sm text-gray-600">Text color for buttons</div>
                    <div class="text-xs text-gray-500">Usually white or light color for contrast</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Prompts Section -->
      <div class="mt-8 pt-8 border-t border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-4">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Prompt Questions
        </h3>
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
          <div id="mode-prompts" class="prompt-input flex flex-wrap gap-2 min-h-[60px]">
            <input id="mode-prompt-input" class="flex-1 outline-none bg-transparent text-gray-700 placeholder-gray-500" placeholder="Add a suggested question and press Enter" />
          </div>
          <p class="text-xs text-gray-500 mt-2">These questions will appear as quick-start options for users</p>
        </div>
      </div>
    </section>
    <!-- Site Management Section -->
    <section class="bg-white rounded-2xl shadow-soft border border-gray-100 p-8 mb-8 animate-slide-up">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900">Site Management</h2>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Preferred Sites Section -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200 shadow-soft">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-green-800">Preferred Sites</h3>
                <p class="text-sm text-green-600">Sites to prioritize in search results</p>
              </div>
            </div>
            <div class="text-right">
              <div id="preferred-count" class="text-xs text-green-600 font-medium bg-green-100 px-2 py-1 rounded-full">0/30 sites</div>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="flex gap-3">
              <input id="preferred-site-input" type="text" class="flex-1 px-4 py-3 border border-green-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="Enter site URL or wildcard (e.g., https://example.com or *.example.com)" />
              <button id="add-preferred-site" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-xl font-medium shadow-medium hover:shadow-strong transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add
              </button>
            </div>
          </div>
          
          <div id="preferred-sites-list" class="space-y-3 max-h-80 overflow-y-auto">
            <!-- Sites will be added here -->
          </div>
        </div>

        <!-- Blocked Sites Section -->
        <div class="bg-gradient-to-br from-red-50 to-rose-50 rounded-2xl p-6 border border-red-200 shadow-soft">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-red-800">Blocked Sites</h3>
                <p class="text-sm text-red-600">Sites to exclude from search results</p>
              </div>
            </div>
            <div class="text-right">
              <div id="blocked-count" class="text-xs text-red-600 font-medium bg-red-100 px-2 py-1 rounded-full">0/30 sites</div>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="flex gap-3">
              <input id="blocked-site-input" type="text" class="flex-1 px-4 py-3 border border-red-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="Enter site URL or wildcard (e.g., https://example.com or *.example.com)" />
              <button id="add-blocked-site" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-xl font-medium shadow-medium hover:shadow-strong transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add
              </button>
            </div>
          </div>
          
          <div id="blocked-sites-list" class="space-y-3 max-h-80 overflow-y-auto">
            <!-- Sites will be added here -->
          </div>
        </div>
      </div>
    </section>

    <!-- Website Scraping Configuration Section -->
    <section class="bg-white rounded-2xl shadow-soft border border-gray-100 p-8 mb-8 animate-slide-up">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900">Website Scraping</h2>
      </div>
      
      <div class="bg-blue-50 rounded-xl p-6 border border-blue-200 mb-6">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <h3 class="text-sm font-semibold text-blue-800 mb-1">How Website Scraping Works</h3>
            <p class="text-sm text-blue-700 mb-2">Scraping automatically downloads and stores content from your configured websites or specific pages, making it instantly available to the AI without live web searches. You can scrape entire sites (which crawls all pages via sitemaps/links) or individual pages. The scraper handles dynamic content, accordions, tabs, and discovers downloadable files automatically.</p>
            <p class="text-sm text-blue-700 mb-2">üìÑ <strong>Embedded PDF Detection:</strong> The scraper automatically detects and extracts PDFs embedded in pages (using &lt;embed&gt;, &lt;object&gt;, or &lt;iframe&gt; tags), so you don't miss any important documents.</p>
            <p class="text-xs text-green-700 font-medium">üíæ Changes to scrape sites are saved automatically‚Äîno need to click the "Save Mode" button!</p>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Scrape Configuration -->
        <div class="space-y-6">
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-200 shadow-soft">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-blue-800">Scrape Sites</h3>
                <p class="text-sm text-blue-600">URLs to automatically scrape for content</p>
              </div>
            </div>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-blue-800 mb-3">Sites to Scrape</label>
                
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-200 mb-4">
                  <div class="space-y-2">
                    <div class="text-xs text-blue-700">
                      <strong>üåê Full Site Scraping:</strong> Enter a base URL (e.g., <code class="bg-blue-100 px-1 rounded">https://example.com</code>) to crawl the entire site automatically via sitemaps and links.
                    </div>
                    <div class="text-xs text-blue-700">
                      <strong>üìÑ Single Page Scraping:</strong> Enter a specific page URL (e.g., <code class="bg-blue-100 px-1 rounded">https://example.com/forms</code>) to scrape only that page.
                    </div>
                    <div class="text-xs text-orange-600 font-semibold mt-2">
                      ‚è± Large sites may take several minutes to complete. Scraping runs in the background so you can continue working.
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-3 mb-4">
                  <input 
                    id="scrape-site-input" 
                    type="text" 
                    class="flex-1 px-4 py-3 border border-blue-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md" 
                    placeholder="Enter site or page URL (e.g., https://example.com or https://example.com/forms)" 
                  />
                  <button 
                    id="add-scrape-site" 
                    class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium shadow-medium hover:shadow-strong transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-2"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add
                  </button>
                </div>
                
                <div id="scrape-sites-list" class="space-y-3 max-h-80 overflow-y-auto">
                  <!-- Sites will be added here -->
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-blue-800 mb-2">Scrape Frequency</label>
                <select 
                  id="scrape-frequency" 
                  class="w-full px-4 py-3 border border-blue-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md"
                >
                  <option value="manual">Manual Only</option>
                  <option value="daily">Daily (2 AM UTC)</option>
                  <option value="weekly">Weekly (Sunday 3 AM UTC)</option>
                </select>
                <p class="text-xs text-blue-600 mt-2">Set how often sites should be automatically re-scraped</p>
              </div>
              
              <div class="flex items-center justify-between pt-4 border-t border-blue-200">
                <div class="text-sm text-blue-700">
                  <div class="font-semibold">Last Scraped:</div>
                  <div id="last-scraped-at" class="text-xs">Never</div>
                </div>
                <button 
                  id="trigger-scrape-btn" 
                  class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium shadow-medium hover:shadow-strong transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-2"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Scrape Now
                </button>
              </div>
              
              <!-- In-Progress Scraping Jobs -->
              <div id="active-scrape-jobs-container" class="mt-6 pt-6 border-t border-blue-200" style="display: none;">
                <div class="flex items-center gap-2 mb-4">
                  <svg class="w-5 h-5 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <h4 class="text-base font-semibold text-blue-800">Active Scraping Jobs</h4>
                </div>
                <div id="active-scrape-jobs-list" class="space-y-3">
                  <!-- Jobs will be populated here -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scraped Content (Sites & Pages Combined) -->
        <div class="space-y-6">
          <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 border border-purple-200 shadow-soft">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-purple-800">Scraped Content</h3>
                <p class="text-sm text-purple-600">Sites and pages providing content to the AI</p>
              </div>
            </div>
            
            <div id="scraped-sites-pages-combined" class="space-y-3 max-h-[600px] overflow-y-auto">
              <div class="text-sm text-purple-500 text-center py-8">
                No sites scraped yet. Add URLs and click "Scrape Now" to get started.
              </div>
            </div>
          </div>
          
          <!-- Discovered Files -->
          <div class="bg-amber-50 rounded-2xl p-6 border border-amber-200 shadow-soft mt-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-amber-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-amber-800">Discovered Files</h3>
                <p class="text-sm text-amber-600">Downloadable and embedded files found during scraping</p>
              </div>
            </div>
            
            <div id="discovered-files-list" class="space-y-3 max-h-96 overflow-y-auto">
              <div class="text-sm text-amber-500 text-center py-8">
                No files discovered yet. Files will appear here after scraping sites.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Advanced Settings Section -->
    <section class="bg-white rounded-2xl shadow-soft border border-gray-100 p-8 mb-8 animate-slide-up">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900">Advanced Settings</h2>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Information Priority -->
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Information Priority
          </h3>
          <div class="space-y-4">
            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
              <div class="space-y-3">
                <label class="flex items-start space-x-3 cursor-pointer group">
                  <input type="radio" name="mode-priority-source" id="mode-priority-sites" value="sites" class="h-5 w-5 text-primary border-gray-300 focus:ring-primary mt-0.5" />
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900 group-hover:text-primary transition-colors">Prioritize preferred sites first</div>
                    <div class="text-xs text-gray-500 mt-1">Search preferred sites before uploaded files</div>
                  </div>
        </label>
                <label class="flex items-start space-x-3 cursor-pointer group">
                  <input type="radio" name="mode-priority-source" id="mode-priority-files" value="files" class="h-5 w-5 text-primary border-gray-300 focus:ring-primary mt-0.5" />
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900 group-hover:text-primary transition-colors">Prioritize files first</div>
                    <div class="text-xs text-gray-500 mt-1">Search uploaded files before preferred sites</div>
                  </div>
        </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Additional Options -->
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
            </svg>
            Additional Options
          </h3>
          <div class="space-y-4">
            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
              <div class="space-y-4">
                <label class="flex items-start space-x-3 cursor-pointer group">
                  <input type="checkbox" id="mode-allow-other" checked class="h-5 w-5 text-primary border-gray-300 rounded focus:ring-primary mt-0.5" />
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900 group-hover:text-primary transition-colors">Allow internet search</div>
                    <div class="text-xs text-gray-500 mt-1">Search the internet after checking preferred sites and files</div>
          </div>
        </label>
                <label class="flex items-start space-x-3 cursor-pointer group">
                  <input type="checkbox" id="mode-allow-upload" class="h-5 w-5 text-primary border-gray-300 rounded focus:ring-primary mt-0.5" />
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900 group-hover:text-primary transition-colors">Allow file uploads</div>
                    <div class="text-xs text-gray-500 mt-1">Let users upload files for analysis</div>
                  </div>
        </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tags Section -->
      <div class="mt-8 pt-8 border-t border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-4">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
          File Tags
        </h3>
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
          <div id="mode-tags" class="tag-input flex flex-wrap gap-2 min-h-[60px]">
            <input id="mode-tag-input" class="flex-1 outline-none bg-transparent text-gray-700 placeholder-gray-500" placeholder="Add a tag for file categorization and press Enter" />
          </div>
          <p class="text-xs text-gray-500 mt-2">Tags help organize uploaded files into categories</p>
        </div>
      </div>
      
      <!-- Save Button -->
      <div class="mt-8 pt-8 border-t border-gray-200 flex justify-between items-center">
        <button id="mode-delete" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-8 py-4 rounded-xl font-semibold shadow-medium hover:shadow-strong transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-3 text-lg" style="display: none;">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          Delete Mode
        </button>
        <div class="flex items-center gap-4">
          <button id="mode-save" class="bg-gradient-to-r from-primary to-primary-light hover:from-primary-dark hover:to-primary text-white px-8 py-4 rounded-xl font-semibold shadow-medium hover:shadow-strong transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-3 text-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Save Mode
          </button>
          <div id="save-message" class="hidden flex items-center text-green-600 font-semibold">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Saved Successfully!
          </div>
        </div>
      </div>
    </section>

    <!-- Documents Section -->
    <section class="bg-white rounded-2xl shadow-soft border border-gray-100 p-8 mb-8 animate-slide-up" id="docs-section" style="display:none">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900">Document Management</h2>
      </div>
      
      <div class="bg-blue-50 rounded-xl p-6 border border-blue-200 mb-6">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <h3 class="text-sm font-semibold text-blue-800 mb-1">How Document Tags Work</h3>
            <p class="text-sm text-blue-700">Adding a tag makes those files searchable for that specific category. For example, if you tag files with "Advocacy", users searching for advocacy-related topics will only search through those tagged files instead of all files.</p>
          </div>
        </div>
      </div>
      
      <div class="space-y-6">
        <!-- File Upload -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            Upload Files
          </h3>
          <div class="space-y-4">
            <input type="file" id="files" multiple class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 bg-white shadow-sm hover:shadow-md" />
            <div id="file-rows" class="space-y-3"></div>
            <button id="upload" class="bg-[#82002d] hover:bg-[#a0003f] text-white px-6 py-3 rounded-xl font-medium shadow-md hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-2 relative z-10 border-0">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              Upload Files
            </button>
          </div>
        </div>
        
        <!-- Existing Documents -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Existing Documents
          </h3>
          <ul id="doc-list" class="space-y-3">
            <!-- Documents will be listed here -->
          </ul>
        </div>
      </div>
    </section>
  </div>

  <script>
    const DEFAULT_THEME_COLOR = '#82002d';
    const DEFAULT_TEXT_COLOR = '#ffffff';

    function normalizeColor(value) {
      if (!value) return DEFAULT_THEME_COLOR;
      const text = String(value).trim();
      if (!text) return DEFAULT_THEME_COLOR;
      const prefixed = text.startsWith('#') ? text : `#${text}`;
      return /^#[0-9a-fA-F]{6}$/.test(prefixed) ? prefixed.toLowerCase() : DEFAULT_THEME_COLOR;
    }

    function normalizeTextColor(value) {
      if (!value) return DEFAULT_TEXT_COLOR;
      const text = String(value).trim();
      if (!text) return DEFAULT_TEXT_COLOR;
      const prefixed = text.startsWith('#') ? text : `#${text}`;
      return /^#[0-9a-fA-F]{6}$/.test(prefixed) ? prefixed.toLowerCase() : DEFAULT_TEXT_COLOR;
    }

    const idToken = localStorage.getItem('idToken') || '';
    
    function redirectToLogin() {
      window.location.href = '/flask/admin/login';
    }
    if (!idToken) {
      redirectToLogin();
    }

    function handleUnauthorized(res) {
      if (res && res.status === 401) {
        redirectToLogin();
        return true;
      }
      return false;
    }

    const params = new URLSearchParams(window.location.search);
    let modeId = params.get('id');
    let modeName = '';
    let modeTags = [];
    let modePrompts = [];
    let modePreferredSites = [];
    let modeBlockedSites = [];
    let modeScrapeSites = [];
    const MAX_PREFERRED_SITES = 30;
    const MAX_BLOCKED_SITES = 30;
    const colorInput = document.getElementById('mode-color');
    const textColorInput = document.getElementById('mode-text-color');
    colorInput.value = DEFAULT_THEME_COLOR;
    textColorInput.value = DEFAULT_TEXT_COLOR;

    async function loadMode() {
      if (!modeId) {
        renderModeTags([]);
        renderModePrompts([]);
        renderSiteLists([], []);
        document.getElementById('mode-priority-sites').checked = true;
        document.getElementById('mode-priority-files').checked = false;
        document.getElementById('mode-allow-upload').checked = false;
        colorInput.value = DEFAULT_THEME_COLOR;
        textColorInput.value = DEFAULT_TEXT_COLOR;
        updateClientUrl();
        
        // Resize textareas for new mode
        setTimeout(() => {
          const descTextarea = document.getElementById('mode-desc');
          const introTextarea = document.getElementById('mode-intro');
          if (descTextarea) autoExpandTextarea(descTextarea);
          if (introTextarea) autoExpandTextarea(introTextarea);
        }, 50);
        return;
      }
      const res = await fetch('/flask/admin/modes/' + modeId, {
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res) || !res.ok) return;
      const m = await res.json();
      modeName = m.name || '';
      modeTags = m.tags || [];
      modePrompts = m.prompts || [];
      modePreferredSites = m.preferred_sites || [];
      modeBlockedSites = m.blocked_sites || [];
      const nameInput = document.getElementById('mode-name');
      nameInput.value = m.name || '';
      nameInput.readOnly = true;
      nameInput.classList.add('bg-gray-100');
      document.getElementById('mode-title').value = m.title || '';
      document.getElementById('mode-desc').value = m.description || '';
      document.getElementById('mode-intro').value = m.intro || '';
      colorInput.value = normalizeColor(m.color);
      textColorInput.value = normalizeTextColor(m.text_color);
      renderModePrompts(modePrompts);
      renderSiteLists(modePreferredSites, modeBlockedSites);
      document.getElementById('mode-allow-other').checked = m.allow_other_sites !== false;
      const priority = (m.priority_source === 'files') ? 'files' : 'sites';
      document.getElementById('mode-priority-' + priority).checked = true;
      document.getElementById('mode-allow-upload').checked = !!m.allow_file_upload;
      renderModeTags(modeTags);
      document.getElementById('docs-section').style.display = 'block';
      document.getElementById('mode-delete').style.display = 'flex';
      loadDocs();
      loadScrapedSites();
      loadScrapedContent();
      loadDiscoveredFiles();
      updateClientUrl();
      
      // Load scraping configuration
      modeScrapeSites = m.scrape_sites || [];
      renderScrapeSitesList();
      document.getElementById('scrape-frequency').value = m.scrape_frequency || 'manual';
      if (m.last_scraped_at) {
        const lastScraped = new Date(m.last_scraped_at);
        document.getElementById('last-scraped-at').textContent = lastScraped.toLocaleString();
      } else {
        document.getElementById('last-scraped-at').textContent = 'Never';
      }
      
      // Resize textareas after loading data
      setTimeout(() => {
        const descTextarea = document.getElementById('mode-desc');
        const introTextarea = document.getElementById('mode-intro');
        if (descTextarea) autoExpandTextarea(descTextarea);
        if (introTextarea) autoExpandTextarea(introTextarea);
      }, 50);
    }

    document.getElementById('mode-save').onclick = async () => {
      const body = {
        title: document.getElementById('mode-title').value,
        description: document.getElementById('mode-desc').value,
        intro: document.getElementById('mode-intro').value,
        prompts: Array.from(document.querySelectorAll('#mode-prompts .chip')).map(c => c.dataset.value),
        tags: Array.from(document.querySelectorAll('#mode-tags .chip')).map(c => c.dataset.value),
        preferred_sites: modePreferredSites,
        blocked_sites: modeBlockedSites,
        allow_other_sites: document.getElementById('mode-allow-other').checked,
        priority_source: (document.querySelector('input[name="mode-priority-source"]:checked') || { value: 'sites' }).value,
        allow_file_upload: document.getElementById('mode-allow-upload').checked,
        scrape_sites: modeScrapeSites,
        scrape_frequency: document.getElementById('scrape-frequency').value,
        color: normalizeColor(colorInput.value),
        text_color: normalizeTextColor(textColorInput.value)
      };
      if (!modeId) {
        body.name = document.getElementById('mode-name').value;
      }
      const opts = {
        method: modeId ? 'PUT' : 'POST',
        headers: {
          'Authorization': 'Bearer ' + idToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      };
      const url = '/flask/admin/modes' + (modeId ? '/' + modeId : '');
      const res = await fetch(url, opts);
      if (handleUnauthorized(res)) {
        return;
      }
      if (res.ok) {
        const data = await res.json();
        if (!modeId) {
          window.location.href = '/flask/admin/mode?id=' + data._id;
        } else {
          loadMode();
          showSavedMessage();
        }
      }
    };

    async function loadDocs() {
      if (!modeName) return;
      const res = await fetch('/flask/admin/documents?mode=' + encodeURIComponent(modeName), {
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res) || !res.ok) return;
      const data = await res.json();
      const list = document.getElementById('doc-list');
      list.innerHTML = '';
      data.documents.forEach(doc => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-3 p-4 bg-gray-50 rounded-xl border border-gray-200 hover:bg-gray-100 transition-colors';
        
        // File info container
        const infoContainer = document.createElement('div');
        infoContainer.className = 'flex-1 min-w-0';
        
        const label = document.createElement('span');
        label.className = 'text-sm text-gray-700 font-medium block truncate';
        label.textContent = (doc.tag ? doc.tag + ' - ' : '') + (doc.s3_key || '');
        label.title = (doc.tag ? doc.tag + ' - ' : '') + (doc.s3_key || '');
        infoContainer.appendChild(label);
        li.appendChild(infoContainer);
        
        // Button container
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'flex gap-2 flex-shrink-0';
        
        // Download button
        if (doc.s3_key) {
          const downloadBtn = document.createElement('a');
          downloadBtn.href = '/flask/admin/documents/' + doc._id + '/download';
          downloadBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 transform hover:-translate-y-0.5 flex items-center gap-1 shadow-sm hover:shadow-md';
          downloadBtn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Download';
          downloadBtn.onclick = async (e) => {
            e.preventDefault();
            try {
              const res = await fetch(downloadBtn.href, {
                headers: { 'Authorization': 'Bearer ' + idToken }
              });
              if (handleUnauthorized(res)) return;
              if (!res.ok) {
                alert('Failed to download file');
                return;
              }
              const blob = await res.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = doc.s3_key.split('/').pop();
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            } catch (error) {
              console.error('Download failed:', error);
              alert('Failed to download file');
            }
          };
          buttonContainer.appendChild(downloadBtn);
        }
        
        // Delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 transform hover:-translate-y-0.5 shadow-sm hover:shadow-md';
        delBtn.onclick = () => deleteDoc(doc._id);
        buttonContainer.appendChild(delBtn);
        
        li.appendChild(buttonContainer);
        list.appendChild(li);
      });
    }

    async function deleteDoc(id) {
      const res = await fetch('/flask/admin/documents/' + id, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res)) {
        return;
      }
      loadDocs();
    }

    // Combined view: Sites with expandable pages
    async function loadScrapedSitesAndPages() {
      if (!modeId) return;
      
      // Fetch both sites and pages data
      const [sitesRes, pagesRes] = await Promise.all([
        fetch('/flask/admin/scrape/sites/' + modeId, {
          headers: { 'Authorization': 'Bearer ' + idToken }
        }),
        fetch('/flask/admin/scrape/status/' + modeId, {
          headers: { 'Authorization': 'Bearer ' + idToken }
        })
      ]);
      
      if (handleUnauthorized(sitesRes) || handleUnauthorized(pagesRes)) return;
      if (!sitesRes.ok || !pagesRes.ok) return;
      
      const sitesData = await sitesRes.json();
      const pagesData = await pagesRes.json();
      
      const container = document.getElementById('scraped-sites-pages-combined');
      container.innerHTML = '';
      
      if (!sitesData.sites || sitesData.sites.length === 0) {
        container.innerHTML = '<div class="text-sm text-purple-500 text-center py-8">No sites scraped yet. Add URLs and click "Scrape Now" to get started.</div>';
        return;
      }
      
      // Group pages by domain
      const pagesByDomain = {};
      if (pagesData.scraped_content) {
        pagesData.scraped_content.forEach(page => {
          try {
            const url = new URL(page.url);
            const domain = url.hostname.replace(/^www\./, '');
            if (!pagesByDomain[domain]) {
              pagesByDomain[domain] = [];
            }
            pagesByDomain[domain].push(page);
          } catch (e) {
            console.error('Invalid URL:', page.url);
          }
        });
      }
      
      // Create expandable site sections
      sitesData.sites.forEach(site => {
        const siteDiv = document.createElement('div');
        siteDiv.className = 'bg-white rounded-xl border border-purple-200 overflow-hidden transition-all';
        
        const pages = pagesByDomain[site.domain] || [];
        const isExpanded = false;
        
        siteDiv.innerHTML = `
          <div class="site-header p-4 cursor-pointer hover:bg-purple-50 transition-colors" data-domain="${site.domain}">
            <div class="flex items-start justify-between gap-3">
              <div class="flex items-center gap-3 flex-1 min-w-0">
                <svg class="expand-icon w-5 h-5 text-purple-600 flex-shrink-0 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <svg class="w-5 h-5 text-purple-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                    </svg>
                    <div class="font-semibold text-purple-900 text-base truncate" title="${site.domain}">${site.domain}</div>
                  </div>
                  <div class="flex gap-4 text-xs text-purple-700">
                    <div><span class="font-medium">${site.total_pages}</span> pages</div>
                    <div><span class="font-medium">${(site.total_words || 0).toLocaleString()}</span> words</div>
                    ${site.last_scraped ? '<div class="text-purple-600">Last: ' + new Date(site.last_scraped).toLocaleDateString() + '</div>' : ''}
                  </div>
                </div>
              </div>
              <button class="delete-site-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all flex items-center gap-2 flex-shrink-0" data-domain="${site.domain}" onclick="event.stopPropagation()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete All
              </button>
            </div>
          </div>
          <div class="pages-container hidden bg-gray-50 border-t border-purple-200" data-domain="${site.domain}">
            <div class="p-4 space-y-2">
              ${pages.length > 0 ? pages.map(page => `
                <div class="p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors page-item" data-page-id="${page._id}">
                  <div class="flex items-start justify-between gap-3 mb-2">
                    <div class="flex-1 min-w-0">
                      <div class="font-medium text-gray-900 text-sm truncate" title="${page.title}">${page.title || 'Untitled'}</div>
                      <div class="text-xs text-gray-500 truncate" title="${page.url}">${page.url}</div>
                    </div>
                    <span class="${page.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} text-xs px-2 py-1 rounded-full font-medium flex-shrink-0">${page.status === 'active' ? 'Active' : 'Failed'}</span>
                  </div>
                  <div class="flex items-center justify-between gap-2 text-xs text-gray-600">
                    <div>
                      <span class="font-medium">${page.word_count || 0}</span> words
                      ${page.scraped_at ? ' ‚Ä¢ ' + new Date(page.scraped_at).toLocaleString() : ''}
                    </div>
                    <div class="flex gap-2">
                      <button class="refresh-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg transition-all" data-id="${page._id}">
                        <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                      </button>
                      <button class="delete-page-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg transition-all" data-id="${page._id}">
                        <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                  ${page.error_message ? `<div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">${page.error_message}</div>` : ''}
                </div>
              `).join('') : '<div class="text-sm text-gray-500 text-center py-4">No individual pages found for this site</div>'}
            </div>
          </div>
        `;
        
        container.appendChild(siteDiv);
      });
      
      // Add toggle functionality
      document.querySelectorAll('.site-header').forEach(header => {
        header.addEventListener('click', (e) => {
          const domain = header.dataset.domain;
          const pagesContainer = document.querySelector(`.pages-container[data-domain="${domain}"]`);
          const expandIcon = header.querySelector('.expand-icon');
          
          if (pagesContainer.classList.contains('hidden')) {
            pagesContainer.classList.remove('hidden');
            expandIcon.style.transform = 'rotate(90deg)';
          } else {
            pagesContainer.classList.add('hidden');
            expandIcon.style.transform = 'rotate(0deg)';
          }
        });
      });
      
      // Add event listeners for delete site buttons
      document.querySelectorAll('.delete-site-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          deleteSiteContent(btn.dataset.domain);
        };
      });
      
      // Add event listeners for page actions
      document.querySelectorAll('.refresh-btn').forEach(btn => {
        btn.onclick = () => refreshScrapedContent(btn.dataset.id);
      });
      document.querySelectorAll('.delete-page-btn').forEach(btn => {
        btn.onclick = () => deleteScrapedContent(btn.dataset.id);
      });
    }
    
    // Legacy aliases for compatibility
    async function loadScrapedSites() {
      return loadScrapedSitesAndPages();
    }
    
    async function loadScrapedContent() {
      // No longer needed as a separate function, handled by loadScrapedSitesAndPages
      return;
    }
    
    async function deleteSiteContent(domain) {
      if (!confirm(`Delete ALL content from ${domain}?\n\nThis will remove all ${domain} pages from this mode. If other modes use this content, it will be unlinked but not deleted.\n\n‚è± Note: Deletion runs in the background and may take a few minutes for large sites.`)) {
        return;
      }
      
      // Optimistically remove site from combined UI immediately
      const container = document.getElementById('scraped-sites-pages-combined');
      const siteHeaders = container.querySelectorAll('.site-header');
      siteHeaders.forEach(header => {
        if (header.dataset.domain === domain) {
          // Remove the entire site div (header + pages)
          header.closest('.bg-white').remove();
        }
      });
      
      // Check if container is now empty
      if (container.querySelectorAll('.site-header').length === 0) {
        container.innerHTML = '<div class="text-sm text-purple-500 text-center py-8">No sites scraped yet. Add URLs and click "Scrape Now" to get started.</div>';
      }
      
      // Show toast notification
      showDeletionToast(domain);
      
      const res = await fetch(`/flask/admin/scrape/site/${modeId}/${encodeURIComponent(domain)}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      
      if (handleUnauthorized(res)) {
        // Reload if unauthorized
        loadScrapedSitesAndPages();
        return;
      }
      
      if (!res.ok) {
        const data = await res.json();
        alert('Failed to start deletion: ' + (data.error || 'Unknown error'));
        // Reload to restore UI
        loadScrapedSitesAndPages();
      }
    }
    
    function showDeletionToast(domain) {
      // Create toast notification
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-xl shadow-strong z-50 max-w-md';
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <div>
            <div class="font-semibold">Deleting content from ${domain}</div>
            <div class="text-sm text-blue-100">This may take a few minutes. You can continue working.</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      // Remove toast after 8 seconds
      setTimeout(() => {
        toast.style.transition = 'opacity 0.3s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 8000);
    }


    async function refreshScrapedContent(contentId) {
      const res = await fetch('/flask/admin/scrape/refresh/' + contentId, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res)) return;
      
      if (res.ok) {
        alert('Content refreshed successfully!');
        loadScrapedSitesAndPages();
      } else {
        const data = await res.json();
        alert('Failed to refresh: ' + (data.error || 'Unknown error'));
      }
    }

    async function deleteScrapedContent(contentId) {
      if (!confirm('Delete this scraped content?\n\n‚è± Note: Deletion from vector store runs in the background and may take a moment.')) return;
      
      // Optimistically remove from combined UI immediately
      const container = document.getElementById('scraped-sites-pages-combined');
      const pageItems = container.querySelectorAll('.page-item');
      pageItems.forEach(item => {
        if (item.dataset.pageId === contentId) {
          item.remove();
        }
      });
      
      // Show mini toast
      showMiniToast('Deleting content...');
      
      const res = await fetch('/flask/admin/scraped-content/' + contentId, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res)) {
        loadScrapedSitesAndPages();
        return;
      }
      
      if (!res.ok) {
        alert('Failed to start deletion');
        // Reload to restore UI
        loadScrapedSitesAndPages();
      }
    }
    
    function showMiniToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-strong z-50';
      toast.innerHTML = `
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <div class="text-sm">${message}</div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.transition = 'opacity 0.3s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Discovered Files Management
    async function loadDiscoveredFiles() {
      if (!modeId) return;
      const res = await fetch('/flask/admin/scrape/discovered-files/' + modeId, {
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res) || !res.ok) return;
      const data = await res.json();
      const list = document.getElementById('discovered-files-list');
      list.innerHTML = '';
      
      if (!data.files || data.files.length === 0) {
        list.innerHTML = '<div class="text-sm text-amber-500 text-center py-8">No files discovered yet. Files will appear here after scraping sites.</div>';
        return;
      }
      
      // Get mode tags for tag selector
      const mode_doc = await fetch('/flask/admin/modes/' + modeId, {
        headers: { 'Authorization': 'Bearer ' + idToken }
      }).then(r => r.json());
      const availableTags = mode_doc.tags || [];
      
      data.files.forEach(file => {
        const div = document.createElement('div');
        div.className = 'p-4 bg-white rounded-xl border border-amber-200 hover:bg-amber-50 transition-colors';
        
        // File type icon
        const fileTypeColors = {
          'pdf': 'text-red-600',
          'doc': 'text-blue-600',
          'docx': 'text-blue-600',
          'xls': 'text-green-600',
          'xlsx': 'text-green-600',
          'ppt': 'text-orange-600',
          'pptx': 'text-orange-600',
          'txt': 'text-gray-600',
          'csv': 'text-green-600',
          'json': 'text-purple-600',
          'xml': 'text-purple-600',
          'zip': 'text-yellow-600',
          'rar': 'text-yellow-600'
        };
        
        const fileColor = fileTypeColors[file.file_extension] || 'text-gray-600';
        
        // Check if this is an embedded PDF
        const isEmbedded = file.is_embedded || false;
        const embedBadge = isEmbedded ? '<span class="inline-block ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full font-medium text-xs">üìÑ EMBEDDED</span>' : '';
        const embedPageInfo = file.embed_page_url ? `<div class="text-xs text-purple-600 mb-1" title="${file.embed_page_url}">üìé Embedded on: ${file.embed_page_url}</div>` : '';
        
        div.innerHTML = `
          <div class="flex items-start justify-between gap-3 mb-3">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <svg class="w-5 h-5 ${fileColor} flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                </svg>
                <div class="font-semibold text-gray-900 text-sm truncate" title="${file.filename}">${file.filename}</div>
                ${embedBadge}
              </div>
              <div class="text-xs text-gray-600 mb-1">
                <span class="inline-block px-2 py-0.5 bg-${fileColor.split('-')[1]}-100 ${fileColor} rounded-full font-medium uppercase">${file.file_extension}</span>
                ${file.file_size ? '<span class="ml-2">' + file.file_size + '</span>' : ''}
                ${file.file_type ? '<span class="ml-2 text-gray-500">' + file.file_type + '</span>' : ''}
              </div>
              ${embedPageInfo}
              <div class="text-xs text-gray-500 mb-1" title="${file.link_text}">Context: ${file.link_text}</div>
              <div class="text-xs text-gray-400 truncate" title="${file.source_page_url}">From: ${file.source_page_title || file.source_page_url}</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            ${availableTags.length > 0 ? `
              <select class="file-tag-select flex-1 px-3 py-2 text-xs border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white" data-file-id="${file._id}">
                <option value="">Select tag (optional)</option>
                ${availableTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
              </select>
            ` : '<div class="flex-1"></div>'}
            <button class="add-file-btn bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white px-4 py-2 rounded-lg text-xs font-medium transition-all shadow-sm hover:shadow-md" data-file-id="${file._id}">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Add to Mode
            </button>
            <button class="remove-file-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-medium transition-all shadow-sm hover:shadow-md" data-file-id="${file._id}" title="Remove from discovered files">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              Remove
            </button>
          </div>
        `;
        
        list.appendChild(div);
      });
      
      // Add event listeners for add buttons
      document.querySelectorAll('.add-file-btn').forEach(btn => {
        btn.onclick = () => addDiscoveredFile(btn.dataset.fileId);
      });
      
      // Add event listeners for remove buttons
      document.querySelectorAll('.remove-file-btn').forEach(btn => {
        btn.onclick = () => removeDiscoveredFile(btn.dataset.fileId);
      });
    }
    
    async function addDiscoveredFile(fileId) {
      // Get tag if selected
      const tagSelect = document.querySelector(`.file-tag-select[data-file-id="${fileId}"]`);
      const tag = tagSelect ? tagSelect.value : '';
      
      const btn = document.querySelector(`.add-file-btn[data-file-id="${fileId}"]`);
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-4 h-4 inline animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Adding...';
      
      const res = await fetch('/flask/admin/scrape/add-file/' + modeId, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + idToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ file_id: fileId, tag: tag })
      });
      
      if (handleUnauthorized(res)) {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
      }
      
      if (res.ok) {
        const data = await res.json();
        showMiniToast('‚úì File added successfully!');
        // Remove the file from the discovered list (it's now in documents)
        btn.closest('.p-4').style.transition = 'opacity 0.3s';
        btn.closest('.p-4').style.opacity = '0';
        setTimeout(() => {
          btn.closest('.p-4').remove();
          // Check if list is now empty
          const list = document.getElementById('discovered-files-list');
          if (list.children.length === 0) {
            list.innerHTML = '<div class="text-sm text-amber-500 text-center py-8">No files discovered yet. Files will appear here after scraping sites.</div>';
          }
        }, 300);
      } else {
        const data = await res.json();
        alert('Failed to add file: ' + (data.error || 'Unknown error'));
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }
    }
    
    async function removeDiscoveredFile(fileId) {
      if (!confirm('Remove this file from the discovered files list?\n\nThis will not delete the actual file from the source, it will just remove it from this list.')) {
        return;
      }
      
      const btn = document.querySelector(`.remove-file-btn[data-file-id="${fileId}"]`);
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-4 h-4 inline animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Removing...';
      
      const res = await fetch('/flask/admin/scrape/discovered-file/' + fileId, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + idToken
        }
      });
      
      if (handleUnauthorized(res)) {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
      }
      
      if (res.ok) {
        showMiniToast('‚úì File removed successfully!');
        // Remove the file from the UI
        btn.closest('.p-4').style.transition = 'opacity 0.3s';
        btn.closest('.p-4').style.opacity = '0';
        setTimeout(() => {
          btn.closest('.p-4').remove();
          // Check if list is now empty
          const list = document.getElementById('discovered-files-list');
          if (list.children.length === 0) {
            list.innerHTML = '<div class="text-sm text-amber-500 text-center py-8">No files discovered yet. Files will appear here after scraping sites.</div>';
          }
        }, 300);
      } else {
        const data = await res.json();
        alert('Failed to remove file: ' + (data.error || 'Unknown error'));
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }
    }

    // Trigger scrape button
    let scrapeJobPollInterval = null;
    let activeJobsListPollInterval = null;
    
    // Load active scraping jobs list
    async function loadActiveScrapingJobs() {
      if (!modeId) return;
      
      try {
        const res = await fetch('/flask/admin/scrape/active-jobs/' + modeId, {
          headers: { 'Authorization': 'Bearer ' + idToken }
        });
        
        if (handleUnauthorized(res)) return;
        if (!res.ok) return;
        
        const data = await res.json();
        const jobs = data.jobs || [];
        
        const container = document.getElementById('active-scrape-jobs-container');
        const list = document.getElementById('active-scrape-jobs-list');
        
        if (jobs.length === 0) {
          container.style.display = 'none';
          return;
        }
        
        container.style.display = 'block';
        list.innerHTML = '';
        
        jobs.forEach(job => {
          const jobDiv = document.createElement('div');
          jobDiv.className = 'bg-white rounded-lg border border-blue-200 p-4';
          
          const progress = job.progress || {};
          let passLabel = '';
          let passBadgeClass = '';
          
          if (progress.current_pass === 1) {
            passLabel = 'Initial scrape';
            passBadgeClass = 'bg-blue-100 text-blue-700';
          } else if (progress.current_pass === 2) {
            passLabel = 'Dynamic content scrape';
            passBadgeClass = 'bg-purple-100 text-purple-700';
          }
          
          let statusText = '';
          if (job.status === 'queued') {
            statusText = 'Waiting to start...';
          } else if (progress.phase === 'discovery_complete' && progress.urls_discovered) {
            statusText = `Discovered ${progress.urls_discovered} URLs. Starting scraping...`;
          } else if (progress.scraped_pages === 0 && progress.reused_pages === 0 && progress.urls_discovered) {
            statusText = `Discovered ${progress.urls_discovered} URLs. Preparing to scrape...`;
          } else {
            statusText = `${progress.scraped_pages || 0} pages scraped, ${progress.reused_pages || 0} reused${progress.failed_pages ? ', ' + progress.failed_pages + ' failed' : ''}`;
            if (progress.urls_discovered) {
              statusText += ` (${progress.urls_discovered} URLs discovered)`;
            }
          }
          
          jobDiv.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-4 h-4 text-blue-600 animate-spin flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span class="font-semibold text-blue-900 text-sm">Scraping Job #${job._id.slice(-6)}</span>
                  ${passLabel ? `<span class="inline-block px-2 py-0.5 ${passBadgeClass} rounded-full text-xs font-semibold">${passLabel}</span>` : ''}
                </div>
                <div class="text-xs text-blue-700 mb-1">
                  ${statusText}
                </div>
                ${progress.current_site ? `<div class="text-xs text-blue-600 truncate" title="${progress.current_site}">Current: ${progress.current_site}</div>` : ''}
                <div class="text-xs text-gray-500 mt-1">
                  Started: ${new Date(job.created_at).toLocaleString()}
                </div>
              </div>
            </div>
          `;
          
          list.appendChild(jobDiv);
        });
      } catch (error) {
        console.error('Error loading active jobs:', error);
      }
    }
    
    // Start polling for active jobs list
    function startActiveJobsListPolling() {
      // Initial load
      loadActiveScrapingJobs();
      
      // Clear any existing interval
      if (activeJobsListPollInterval) {
        clearInterval(activeJobsListPollInterval);
      }
      
      // Poll every 3 seconds
      activeJobsListPollInterval = setInterval(loadActiveScrapingJobs, 3000);
    }
    
    // Stop polling for active jobs list
    function stopActiveJobsListPolling() {
      if (activeJobsListPollInterval) {
        clearInterval(activeJobsListPollInterval);
        activeJobsListPollInterval = null;
      }
    }
    
    document.getElementById('trigger-scrape-btn').onclick = async () => {
      if (!modeId) {
        alert('Please save the mode first before scraping.');
        return;
      }
      
      const btn = document.getElementById('trigger-scrape-btn');
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      
      // Trigger the scrape job
      const res = await fetch('/flask/admin/scrape/trigger/' + modeId, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      
      if (handleUnauthorized(res)) {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
      }
      
      if (res.ok) {
        const data = await res.json();
        const jobId = data.job_id;
        
        // Show status message
        showScrapeJobStatus(jobId, btn, originalHTML);
        
        // Start polling for job status
        pollScrapeJob(jobId, btn, originalHTML);
      } else {
        const data = await res.json();
        alert('Failed to start scraping: ' + (data.error || 'Unknown error'));
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }
    };
    
    function showScrapeJobStatus(jobId, btn, originalHTML) {
      // Create a status message area
      const statusDiv = document.getElementById('scrape-job-status') || createScrapeJobStatusDiv();
      statusDiv.innerHTML = `
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl">
          <div class="flex items-center gap-3">
            <svg class="w-5 h-5 animate-spin text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <div class="flex-1">
              <div class="font-semibold text-blue-800">Scraping in progress...</div>
              <div class="text-sm text-blue-600">
                <span id="scrape-job-message">Starting scrape job...</span>
                <br/>
                <span class="text-xs text-blue-500">
                  Depending on the size of the site(s), this may take several minutes. You can continue working; the page will update automatically when complete.
                </span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      btn.innerHTML = '<svg class="w-4 h-4 animate-spin inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Scraping...';
    }
    
    function createScrapeJobStatusDiv() {
      const statusDiv = document.createElement('div');
      statusDiv.id = 'scrape-job-status';
      const scrapeSection = document.getElementById('trigger-scrape-btn').closest('.space-y-4');
      scrapeSection.appendChild(statusDiv);
      return statusDiv;
    }
    
    async function pollScrapeJob(jobId, btn, originalHTML) {
      // Clear any existing polling interval
      if (scrapeJobPollInterval) {
        clearInterval(scrapeJobPollInterval);
      }
      
      // Poll every 3 seconds
      scrapeJobPollInterval = setInterval(async () => {
        const res = await fetch('/flask/admin/scrape/job/' + jobId, {
          headers: { 'Authorization': 'Bearer ' + idToken }
        });
        
        if (handleUnauthorized(res)) {
          clearInterval(scrapeJobPollInterval);
          return;
        }
        
        if (!res.ok) {
          clearInterval(scrapeJobPollInterval);
          updateScrapeJobStatus('Failed to get job status', 'error');
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          return;
        }
        
        const job = await res.json();
        const progress = job.progress || {};
        
        if (job.status === 'queued') {
          updateScrapeJobMessage('Waiting to start...');
        } else if (job.status === 'in_progress') {
          let message = '';
          
          // Check if in URL discovery phase
          if (progress.phase === 'discovery_complete' && progress.urls_discovered) {
            message = `Discovered ${progress.urls_discovered} URLs to scrape. Starting scraping...`;
          } else if (progress.scraped_pages === 0 && progress.reused_pages === 0 && progress.urls_discovered) {
            // Still discovering URLs or preparing to scrape
            message = `Discovered ${progress.urls_discovered} URLs. Preparing to scrape...`;
          } else {
            // Normal scraping in progress
            // Determine pass based on progress
            let passInfo = '';
            if (progress.current_pass === 1) {
              passInfo = ' <span class="inline-block px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold ml-2">Initial scrape</span>';
            } else if (progress.current_pass === 2) {
              passInfo = ' <span class="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold ml-2">Dynamic content scrape</span>';
            }
            
            message = `Scraping: ${progress.scraped_pages || 0} pages scraped, ${progress.reused_pages || 0} reused${progress.failed_pages ? ', ' + progress.failed_pages + ' failed' : ''}${passInfo}`;
            
            // Add URLs discovered info if available
            if (progress.urls_discovered) {
              message += ` <span class="text-gray-500">(${progress.urls_discovered} URLs discovered)</span>`;
            }
          }
          
          updateScrapeJobMessage(message);
        } else if (job.status === 'completed') {
          clearInterval(scrapeJobPollInterval);
          const totalPages = (progress.scraped_pages || 0) + (progress.reused_pages || 0);
          updateScrapeJobStatus(
            `‚úì Scraping complete! ${totalPages} pages available (${progress.scraped_pages || 0} new, ${progress.reused_pages || 0} reused${progress.failed_pages ? ', ' + progress.failed_pages + ' failed' : ''})`,
            'success'
          );
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          loadMode(); // Reload to update last scraped timestamp
          loadScrapedSites();
          loadScrapedContent();
          loadDiscoveredFiles();
          loadActiveScrapingJobs(); // Refresh active jobs list
        } else if (job.status === 'failed') {
          clearInterval(scrapeJobPollInterval);
          updateScrapeJobStatus('‚úó Scraping failed: ' + (job.error || 'Unknown error'), 'error');
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          loadActiveScrapingJobs(); // Refresh active jobs list
        }
      }, 3000); // Poll every 3 seconds
    }
    
    function updateScrapeJobMessage(message) {
      const msgElement = document.getElementById('scrape-job-message');
      if (msgElement) {
        msgElement.innerHTML = message;
      }
    }
    
    function updateScrapeJobStatus(message, type) {
      const statusDiv = document.getElementById('scrape-job-status');
      if (!statusDiv) return;
      
      const bgColor = type === 'success' ? 'bg-green-50 border-green-200' : type === 'error' ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200';
      const textColor = type === 'success' ? 'text-green-800' : type === 'error' ? 'text-red-800' : 'text-blue-800';
      const iconColor = type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600';
      const icon = type === 'success' ? 
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
        type === 'error' ?
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' :
        '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>';
      
      statusDiv.innerHTML = `
        <div class="mt-4 p-4 ${bgColor} border rounded-xl">
          <div class="flex items-center gap-3">
            <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${icon}
            </svg>
            <div class="${textColor} font-medium">${message}</div>
          </div>
        </div>
      `;
      
      // Auto-hide success/error messages after 10 seconds
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          if (statusDiv) {
            statusDiv.innerHTML = '';
          }
        }, 10000);
      }
    }

    document.getElementById('upload').onclick = async () => {
      const rows = document.querySelectorAll('#file-rows .file-row');
      for (const row of rows) {
        const file = row.file;
        const tag = row.querySelector('select').value;
        const form = new FormData();
        form.append('mode', modeName);
        form.append('tag', tag);
        form.append('content', '');
        form.append('file', file);
        const res = await fetch('/flask/admin/documents', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + idToken },
          body: form
        });
        if (handleUnauthorized(res)) {
          return;
        }
      }
      document.getElementById('files').value = '';
      document.getElementById('file-rows').innerHTML = '';
      loadDocs();
    };

    function buildFileRows() {
      const container = document.getElementById('file-rows');
      container.innerHTML = '';
      Array.from(document.getElementById('files').files).forEach(file => {
        const row = document.createElement('div');
        row.className = 'file-row flex items-center gap-2 border border-gray-200 rounded p-2';
        row.file = file;
        const name = document.createElement('span');
        name.textContent = file.name;
        const select = document.createElement('select');
        select.className = 'border border-gray-300 rounded px-2 py-1';
        modeTags.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          select.appendChild(opt);
        });
        row.appendChild(name);
        row.appendChild(select);
        container.appendChild(row);
      });
    }

    function renderModeTags(tags) {
      const container = document.getElementById('mode-tags');
      container.innerHTML = '';
      const label = container.closest('label');
      if (label) {
        label.addEventListener('click', e => {
          // Only prevent default if clicking on chips or chip content
          e.preventDefault();
          e.stopPropagation();
        });
      }
      const input = document.createElement('input');
      input.id = 'mode-tag-input';
      input.placeholder = 'Add tag and press Enter';
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter' && input.value.trim()) {
          addModeTag(input.value.trim());
          input.value = '';
        }
      });
      container.appendChild(input);
      modeTags = [...(tags || [])];
      modeTags.forEach(tag => {
        container.insertBefore(createTagChip(tag, container), input);
      });
    }

    function createTagChip(tag, container) {
      const chip = document.createElement('span');
      chip.className = 'chip inline-flex items-center bg-[#82002d] text-white rounded-full px-2 py-1 text-sm';
      chip.dataset.value = tag;
      
      // Create a span for the tag text
      const tagText = document.createElement('span');
      tagText.textContent = tag;
      chip.appendChild(tagText);
      
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'ml-1 focus:outline-none';
      btn.textContent = '√ó';
      
      // Use addEventListener instead of onclick to have better control
      btn.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        // Find the index in the modeTags array by value, not DOM position
        const index = modeTags.indexOf(tag);
        if (index !== -1) {
          modeTags.splice(index, 1);
        }
        chip.remove();
      });
      
      // Prevent the chip itself from being clickable by the label
      chip.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
      });
      
      chip.appendChild(btn);
      return chip;
    }

    function addModeTag(tag) {
      modeTags.push(tag);
      const container = document.getElementById('mode-tags');
      const input = document.getElementById('mode-tag-input');
      container.insertBefore(createTagChip(tag, container), input);
    }

    function renderModePrompts(prompts) {
      const container = document.getElementById('mode-prompts');
      container.innerHTML = '';
      
      // Prevent the label from interfering with chip clicks
      const label = container.closest('label');
      if (label) {
        label.addEventListener('click', e => {
          // Only prevent default if clicking on chips or chip content
          e.preventDefault();
          e.stopPropagation();
        });
      }
      
      const input = document.createElement('input');
      input.id = 'mode-prompt-input';
      input.placeholder = 'Add prompt and press Enter';
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter' && input.value.trim()) {
          addModePrompt(input.value.trim());
          input.value = '';
        }
      });
      container.appendChild(input);
      modePrompts = [...(prompts || [])];
      modePrompts.forEach(prompt => {
        container.insertBefore(createPromptChip(prompt, container), input);
      });
    }

    function createPromptChip(prompt, container) {
      const chip = document.createElement('span');
      chip.className = 'chip inline-flex items-center bg-[#82002d] text-white rounded-full px-2 py-1 text-sm';
      chip.dataset.value = prompt;
      
      // Create a span for the prompt text
      const promptText = document.createElement('span');
      promptText.textContent = prompt;
      chip.appendChild(promptText);
      
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'ml-1 focus:outline-none';
      btn.textContent = '√ó';
      
      // Use addEventListener instead of onclick to have better control
      btn.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        // Find the index in the modePrompts array by value, not DOM position
        const index = modePrompts.indexOf(prompt);
        if (index !== -1) {
          modePrompts.splice(index, 1);
        }
        chip.remove();
      });
      
      // Prevent the chip itself from being clickable by the label
      chip.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
      });
      
      chip.appendChild(btn);
      return chip;
    }

    function addModePrompt(prompt) {
      modePrompts.push(prompt);
      const container = document.getElementById('mode-prompts');
      const input = document.getElementById('mode-prompt-input');
      container.insertBefore(createPromptChip(prompt, container), input);
    }

    function updateSiteCounts() {
      const preferredCountEl = document.getElementById('preferred-count');
      const blockedCountEl = document.getElementById('blocked-count');
      
      if (preferredCountEl) {
        const count = modePreferredSites.length;
        const isAtLimit = count >= MAX_PREFERRED_SITES;
        preferredCountEl.textContent = `${count}/${MAX_PREFERRED_SITES} sites`;
        preferredCountEl.className = `text-xs ${isAtLimit ? 'text-red-500 font-semibold' : 'text-gray-400'}`;
      }
      
      if (blockedCountEl) {
        const count = modeBlockedSites.length;
        const isAtLimit = count >= MAX_BLOCKED_SITES;
        blockedCountEl.textContent = `${count}/${MAX_BLOCKED_SITES} sites`;
        blockedCountEl.className = `text-xs ${isAtLimit ? 'text-red-500 font-semibold' : 'text-gray-400'}`;
      }
    }

    function renderSiteLists(preferredSites, blockedSites) {
      modePreferredSites = [...(preferredSites || [])];
      modeBlockedSites = [...(blockedSites || [])];
      
      renderPreferredSitesList();
      renderBlockedSitesList();
      updateSiteCounts();
    }

    function renderPreferredSitesList() {
      const container = document.getElementById('preferred-sites-list');
      container.innerHTML = '';
      
      if (modePreferredSites.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'text-center py-8';
        emptyMsg.innerHTML = `
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
            </svg>
          </div>
          <p class="text-gray-500 text-sm font-medium">No preferred sites added yet</p>
          <p class="text-gray-400 text-xs mt-1">Add sites to prioritize in search results</p>
        `;
        container.appendChild(emptyMsg);
        return;
      }
      
      modePreferredSites.forEach((site, index) => {
        const siteItem = createSiteListItem(site, index, 'preferred');
        container.appendChild(siteItem);
      });
    }

    function renderBlockedSitesList() {
      const container = document.getElementById('blocked-sites-list');
      container.innerHTML = '';
      
      if (modeBlockedSites.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'text-center py-8';
        emptyMsg.innerHTML = `
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </div>
          <p class="text-gray-500 text-sm font-medium">No blocked sites added yet</p>
          <p class="text-gray-400 text-xs mt-1">Add sites to exclude from search results</p>
        `;
        container.appendChild(emptyMsg);
        return;
      }
      
      modeBlockedSites.forEach((site, index) => {
        const siteItem = createSiteListItem(site, index, 'blocked');
        container.appendChild(siteItem);
      });
    }

    function createSiteListItem(site, index, type) {
      const item = document.createElement('div');
      item.className = 'flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-move';
      item.dataset.index = index;
      item.draggable = true;
      
      // Add drag event listeners
      item.addEventListener('dragstart', (e) => handleDragStart(e, item, type));
      item.addEventListener('dragend', (e) => handleDragEnd(e, item));
      item.addEventListener('dragover', (e) => handleDragOver(e));
      item.addEventListener('drop', (e) => handleDrop(e, item, type));
      
      // Priority number for preferred sites
      if (type === 'preferred') {
        const priorityBadge = document.createElement('span');
        priorityBadge.className = 'bg-gradient-to-r from-green-500 to-green-600 text-white text-xs font-bold px-3 py-1 rounded-full min-w-[32px] text-center shadow-sm';
        priorityBadge.textContent = index + 1;
        item.appendChild(priorityBadge);
      }
      
      // Site URL with icon
      const siteContainer = document.createElement('div');
      siteContainer.className = 'flex items-center gap-2 flex-1 min-w-0';
      
      const siteIcon = document.createElement('div');
      siteIcon.className = 'w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0';
      siteIcon.innerHTML = '<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path></svg>';
      
      const siteUrl = document.createElement('span');
      siteUrl.className = 'text-sm text-gray-700 break-all font-medium';
      siteUrl.textContent = site;
      
      siteContainer.appendChild(siteIcon);
      siteContainer.appendChild(siteUrl);
      item.appendChild(siteContainer);
      
      // Action buttons
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'flex gap-1';
      
      // Edit button
      const editBtn = document.createElement('button');
      editBtn.className = 'text-blue-600 hover:text-blue-800 hover:bg-blue-50 text-sm px-3 py-2 rounded-lg transition-all duration-200 flex items-center gap-1';
      editBtn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>Edit';
      editBtn.addEventListener('click', () => editSite(site, index, type));
      buttonContainer.appendChild(editBtn);
      
      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'text-red-600 hover:text-red-800 hover:bg-red-50 text-sm px-3 py-2 rounded-lg transition-all duration-200 flex items-center gap-1';
      deleteBtn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Delete';
      deleteBtn.addEventListener('click', () => deleteSite(index, type));
      buttonContainer.appendChild(deleteBtn);
      
      // Drag handle icon for visual indication
      const dragHandle = document.createElement('div');
      dragHandle.className = 'text-gray-400 hover:text-gray-600 cursor-move flex items-center';
      dragHandle.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>';
      dragHandle.title = 'Drag to reorder';
      buttonContainer.appendChild(dragHandle);
      
      item.appendChild(buttonContainer);
      return item;
    }

    // Drag and drop functionality
    let draggedElement = null;
    let draggedType = null;
    
    function clearAllDropIndicators() {
      document.querySelectorAll('.drop-indicator').forEach(indicator => {
        indicator.remove();
      });
    }

    function handleDragStart(e, element, type) {
      clearAllDropIndicators(); // Clear any existing indicators
      draggedElement = element;
      draggedType = type;
      element.classList.add('opacity-50', 'scale-95');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', element.outerHTML);
    }

    function handleDragEnd(e, element) {
      element.classList.remove('opacity-50', 'scale-95');
      clearAllDropIndicators();
      draggedElement = null;
      draggedType = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const container = e.currentTarget.parentNode;
      
      // Remove any existing indicators in this container
      container.querySelectorAll('.drop-indicator').forEach(indicator => {
        indicator.remove();
      });
      
      const afterElement = getDragAfterElement(container, e.clientY);
      
      if (afterElement == null) {
        container.appendChild(createDropIndicator());
      } else {
        container.insertBefore(createDropIndicator(), afterElement);
      }
    }

    function handleDrop(e, element, type) {
      e.preventDefault();
      
      if (draggedType !== type) return; // Can't drop between different types
      
      const afterElement = getDragAfterElement(e.currentTarget.parentNode, e.clientY);
      const dragging = draggedElement;
      
      if (afterElement == null) {
        e.currentTarget.parentNode.appendChild(dragging);
      } else {
        e.currentTarget.parentNode.insertBefore(dragging, afterElement);
      }
      
      // Update the arrays and re-render
      updateSiteOrder(type);
      
      // Remove drop indicators
      clearAllDropIndicators();
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.opacity-50)')];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function createDropIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'drop-indicator h-1 bg-blue-500 rounded-full mx-4 my-2';
      indicator.style.transition = 'opacity 0.2s ease';
      return indicator;
    }

    function updateSiteOrder(type) {
      const container = type === 'preferred' ? 
        document.getElementById('preferred-sites-list') : 
        document.getElementById('blocked-sites-list');
      
      const items = Array.from(container.querySelectorAll('[draggable="true"]'));
      const newOrder = items.map(item => {
        const index = parseInt(item.dataset.index);
        return type === 'preferred' ? modePreferredSites[index] : modeBlockedSites[index];
      });
      
      if (type === 'preferred') {
        modePreferredSites = newOrder;
        renderPreferredSitesList();
      } else {
        modeBlockedSites = newOrder;
        renderBlockedSitesList();
      }
      
      updateSiteCounts();
    }

    function isValidUrlOrWildcard(url) {
      // Check if it's a valid URL first
      try {
        new URL(url);
        return true;
      } catch {
        // If not a valid URL, check if it's a wildcard pattern
        // Allow patterns like *.domain.com, *.subdomain.domain.com, etc.
        const wildcardPattern = /^\*\.([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)*[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?$/;
        return wildcardPattern.test(url);
      }
    }

    function addSite(type) {
      const inputId = type === 'preferred' ? 'preferred-site-input' : 'blocked-site-input';
      const input = document.getElementById(inputId);
      const url = input.value.trim();
      
      if (!url) {
        alert('Please enter a valid URL');
        return;
      }
      
      // Check maximum limits
      if (type === 'preferred' && modePreferredSites.length >= MAX_PREFERRED_SITES) {
        alert(`Maximum of ${MAX_PREFERRED_SITES} preferred sites allowed. Please remove some sites before adding new ones.`);
        return;
      }
      
      if (type === 'blocked' && modeBlockedSites.length >= MAX_BLOCKED_SITES) {
        alert(`Maximum of ${MAX_BLOCKED_SITES} blocked sites allowed. Please remove some sites before adding new ones.`);
        return;
      }
      
      // Enhanced URL validation that allows wildcards
      if (!isValidUrlOrWildcard(url)) {
        alert('Please enter a valid URL or wildcard pattern (e.g., https://example.com or *.example.com)');
        return;
      }
      
      if (type === 'preferred') {
        modePreferredSites.push(url);
        renderPreferredSitesList();
        updateSiteCounts();
      } else {
        modeBlockedSites.push(url);
        renderBlockedSitesList();
        updateSiteCounts();
      }
      
      input.value = '';
    }

    function editSite(site, index, type) {
      const newUrl = prompt('Edit site URL:', site);
      if (newUrl === null) return; // User cancelled
      
      const trimmedUrl = newUrl.trim();
      if (!trimmedUrl) {
        alert('URL cannot be empty');
        return;
      }
      
      // Enhanced URL validation that allows wildcards
      if (!isValidUrlOrWildcard(trimmedUrl)) {
        alert('Please enter a valid URL or wildcard pattern (e.g., https://example.com or *.example.com)');
        return;
      }
      
      if (type === 'preferred') {
        modePreferredSites[index] = trimmedUrl;
        renderPreferredSitesList();
      } else {
        modeBlockedSites[index] = trimmedUrl;
        renderBlockedSitesList();
      }
    }

    function deleteSite(index, type) {
      if (!confirm('Are you sure you want to delete this site?')) return;
      
      if (type === 'preferred') {
        modePreferredSites.splice(index, 1);
        renderPreferredSitesList();
        updateSiteCounts();
      } else {
        modeBlockedSites.splice(index, 1);
        renderBlockedSitesList();
        updateSiteCounts();
      }
    }

    // Scrape Sites Management
    function renderScrapeSitesList() {
      const container = document.getElementById('scrape-sites-list');
      container.innerHTML = '';
      
      if (modeScrapeSites.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'text-center py-8';
        emptyMsg.innerHTML = `
          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
            </svg>
          </div>
          <p class="text-gray-500 text-sm font-medium">No sites added yet</p>
          <p class="text-gray-400 text-xs mt-1">Add websites to scrape for content</p>
        `;
        container.appendChild(emptyMsg);
        return;
      }
      
      modeScrapeSites.forEach((site, index) => {
        const item = document.createElement('div');
        item.className = 'flex items-center gap-3 p-4 bg-white rounded-xl border border-blue-200 shadow-sm hover:shadow-md transition-all duration-200';
        
        // Site URL with icon
        const siteContainer = document.createElement('div');
        siteContainer.className = 'flex items-center gap-2 flex-1 min-w-0';
        
        const siteIcon = document.createElement('div');
        siteIcon.className = 'flex-shrink-0';
        siteIcon.innerHTML = `
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9c0 1.657 4.03 3 9 3s9-1.343 9-3m-9-9c0 1.657-4.03 3-9 3s-9-1.343-9-3m0 0v6"></path>
          </svg>
        `;
        
        const siteText = document.createElement('span');
        siteText.className = 'text-sm text-gray-700 truncate font-mono';
        siteText.textContent = site;
        siteText.title = site;
        
        siteContainer.appendChild(siteIcon);
        siteContainer.appendChild(siteText);
        
        // Action buttons
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'flex gap-2 flex-shrink-0';
        
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors duration-200';
        editBtn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
        `;
        editBtn.onclick = () => editScrapeSite(site, index);
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200';
        deleteBtn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        `;
        deleteBtn.onclick = () => deleteScrapeSite(index);
        
        actionsContainer.appendChild(editBtn);
        actionsContainer.appendChild(deleteBtn);
        
        item.appendChild(siteContainer);
        item.appendChild(actionsContainer);
        container.appendChild(item);
      });
    }

    async function addScrapeSite() {
      const input = document.getElementById('scrape-site-input');
      const url = input.value.trim();
      
      if (!url) {
        alert('Please enter a valid URL');
        return;
      }
      
      // Basic URL validation
      try {
        const urlObj = new URL(url);
        if (!urlObj.protocol.startsWith('http')) {
          throw new Error('Must be HTTP or HTTPS');
        }
      } catch (e) {
        alert('Please enter a valid URL (e.g., https://example.com)');
        return;
      }
      
      // Check for duplicates
      if (modeScrapeSites.includes(url)) {
        alert('This site has already been added');
        return;
      }
      
      modeScrapeSites.push(url);
      renderScrapeSitesList();
      input.value = '';
      
      // Auto-save after adding
      await autoSaveScrapeSites();
    }

    async function editScrapeSite(site, index) {
      const newUrl = prompt('Edit site URL:', site);
      if (newUrl === null) return; // User cancelled
      
      const trimmedUrl = newUrl.trim();
      if (!trimmedUrl) {
        alert('URL cannot be empty');
        return;
      }
      
      // Basic URL validation
      try {
        const urlObj = new URL(trimmedUrl);
        if (!urlObj.protocol.startsWith('http')) {
          throw new Error('Must be HTTP or HTTPS');
        }
      } catch (e) {
        alert('Please enter a valid URL (e.g., https://example.com)');
        return;
      }
      
      modeScrapeSites[index] = trimmedUrl;
      renderScrapeSitesList();
      
      // Auto-save after editing
      await autoSaveScrapeSites();
    }

    async function deleteScrapeSite(index) {
      if (!confirm('Are you sure you want to delete this site?')) return;
      
      modeScrapeSites.splice(index, 1);
      renderScrapeSitesList();
      
      // Auto-save after deleting
      await autoSaveScrapeSites();
    }


    // Auto-save scrape sites changes
    async function autoSaveScrapeSites() {
      // Only auto-save if mode already exists (has been saved at least once)
      if (!modeId) {
        console.log('Mode not saved yet, skipping auto-save');
        return;
      }
      
      try {
        // Show brief saving indicator
        showAutoSaveIndicator('Saving...');
        
        const body = {
          title: document.getElementById('mode-title').value,
          description: document.getElementById('mode-desc').value,
          intro: document.getElementById('mode-intro').value,
          prompts: Array.from(document.querySelectorAll('#mode-prompts .chip')).map(c => c.dataset.value),
          tags: Array.from(document.querySelectorAll('#mode-tags .chip')).map(c => c.dataset.value),
          preferred_sites: modePreferredSites,
          blocked_sites: modeBlockedSites,
          allow_other_sites: document.getElementById('mode-allow-other').checked,
          priority_source: (document.querySelector('input[name="mode-priority-source"]:checked') || { value: 'sites' }).value,
          allow_file_upload: document.getElementById('mode-allow-upload').checked,
          scrape_sites: modeScrapeSites,
          scrape_frequency: document.getElementById('scrape-frequency').value,
          color: normalizeColor(colorInput.value),
          text_color: normalizeTextColor(textColorInput.value)
        };
        
        const res = await fetch('/flask/admin/modes/' + modeId, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + idToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        
        if (handleUnauthorized(res)) {
          return;
        }
        
        if (res.ok) {
          showAutoSaveIndicator('‚úì Saved', 'success');
        } else {
          showAutoSaveIndicator('‚úó Save failed', 'error');
        }
      } catch (error) {
        console.error('Auto-save error:', error);
        showAutoSaveIndicator('‚úó Save failed', 'error');
      }
    }
    
    // Show auto-save indicator near scrape section
    function showAutoSaveIndicator(message, type = 'info') {
      // Find or create indicator element
      let indicator = document.getElementById('auto-save-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'auto-save-indicator';
        indicator.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-strong z-50 text-sm font-medium transition-all duration-300';
        document.body.appendChild(indicator);
      }
      
      // Set styling based on type
      if (type === 'success') {
        indicator.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-strong z-50 text-sm font-medium transition-all duration-300 bg-green-600 text-white';
      } else if (type === 'error') {
        indicator.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-strong z-50 text-sm font-medium transition-all duration-300 bg-red-600 text-white';
      } else {
        indicator.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-strong z-50 text-sm font-medium transition-all duration-300 bg-blue-600 text-white';
      }
      
      indicator.textContent = message;
      indicator.style.opacity = '1';
      
      // Auto-hide after delay
      setTimeout(() => {
        indicator.style.opacity = '0';
      }, type === 'success' ? 2000 : 3000);
    }
    
    function showSavedMessage() {
      const msg = document.getElementById('save-message');
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 2000);
    }

    document.getElementById('back-to-admin').onclick = () => {
      window.location.href = '/flask/admin';
    };

    document.getElementById('mode-delete').onclick = async () => {
      if (!modeId) return;
      
      const modeName = document.getElementById('mode-name').value || 'this mode';
      const confirmMessage = `Are you sure you want to delete "${modeName}"?\n\nThis will permanently delete:\n‚Ä¢ The mode configuration\n‚Ä¢ All associated documents\n‚Ä¢ All uploaded files\n\nThis action cannot be undone.`;
      
      if (!confirm(confirmMessage)) return;
      
      // Second confirmation for extra safety
      if (!confirm('Are you absolutely sure? This cannot be undone!')) return;
      
      try {
        const res = await fetch('/flask/admin/modes/' + modeId, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + idToken }
        });
        
        if (handleUnauthorized(res)) {
          return;
        }
        
        if (res.ok) {
          alert('Mode and all associated documents deleted successfully.');
          window.location.href = '/flask/admin';
        } else {
          const data = await res.json();
          alert('Failed to delete mode: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Delete failed:', error);
        alert('Failed to delete mode. Please try again.');
      }
    };

    document.getElementById('files').addEventListener('change', buildFileRows);

    function updateClientUrl() {
      const nameValue = document.getElementById('mode-name').value.trim();
      const link = document.getElementById('client-url');
      const wrapper = document.getElementById('client-url-wrapper');
      if (!link || !wrapper) return;
      if (!nameValue) {
        link.textContent = '‚Äî';
        link.removeAttribute('href');
        wrapper.classList.add('text-gray-400');
        return;
      }
      const url = 'https://bcca.ai/flask/?mode=' + encodeURIComponent(nameValue);
      link.textContent = url;
      link.href = url;
      link.target = '_blank';
      wrapper.classList.remove('text-gray-400');
    }

    document.getElementById('mode-name').addEventListener('input', updateClientUrl);

    // Site management event listeners
    document.getElementById('add-preferred-site').addEventListener('click', () => addSite('preferred'));
    document.getElementById('add-blocked-site').addEventListener('click', () => addSite('blocked'));
    document.getElementById('add-scrape-site').addEventListener('click', addScrapeSite);
    
    // Allow Enter key to add sites
    document.getElementById('preferred-site-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addSite('preferred');
      }
    });
    
    document.getElementById('blocked-site-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addSite('blocked');
      }
    });
    
    document.getElementById('scrape-site-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addScrapeSite();
      }
    });
    
    // Auto-save when scrape frequency changes
    document.getElementById('scrape-frequency').addEventListener('change', async () => {
      await autoSaveScrapeSites();
    });

    updateClientUrl();

    // Auto-expand textarea functionality
    function autoExpandTextarea(textarea) {
      // Reset height to auto to get the correct scrollHeight
      textarea.style.height = 'auto';
      // Set height to scrollHeight to fit content
      textarea.style.height = Math.max(textarea.scrollHeight, 80) + 'px';
    }

    // Add auto-expand functionality to description and introduction textareas
    function setupAutoExpand() {
      const descTextarea = document.getElementById('mode-desc');
      const introTextarea = document.getElementById('mode-intro');
      
      if (descTextarea) {
        descTextarea.addEventListener('input', () => autoExpandTextarea(descTextarea));
        // Initial resize
        autoExpandTextarea(descTextarea);
      }
      
      if (introTextarea) {
        introTextarea.addEventListener('input', () => autoExpandTextarea(introTextarea));
        // Initial resize
        autoExpandTextarea(introTextarea);
      }
    }

    loadMode();
    
    // Start polling for active scraping jobs
    startActiveJobsListPolling();
    
    // Cleanup polling when page unloads
    window.addEventListener('beforeunload', () => {
      stopActiveJobsListPolling();
      if (scrapeJobPollInterval) {
        clearInterval(scrapeJobPollInterval);
      }
    });
    
    // Setup auto-expand after the page loads
    setTimeout(setupAutoExpand, 100);
  </script>
</body>
</html>