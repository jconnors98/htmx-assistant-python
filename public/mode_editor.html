<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Mode Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#82002d',
            'primary-light': '#a0003f',
            'primary-dark': '#6b0024',
            secondary: '#f8fafc',
            accent: '#e2e8f0'
          },
          boxShadow: {
            'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
            'medium': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
            'strong': '0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'pulse-soft': 'pulseSoft 2s infinite'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            pulseSoft: {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.8' }
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Drag and drop styles */
    .dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }
    
    .drop-indicator {
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
      border-radius: 1px;
      margin: 4px 16px;
      transition: opacity 0.2s ease;
    }
    
    [draggable="true"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    [draggable="true"]:active {
      cursor: grabbing;
    }

    /* Tab Styles */
    .tab-btn {
      position: relative;
      transition: all 0.2s ease;
    }
    .tab-btn.active {
      color: #82002d;
      background-color: #fff;
      border-bottom-color: #82002d;
    }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #82002d;
    }
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }
    .tab-content.active {
      display: block;
    }
    
    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 flex flex-col h-screen overflow-hidden">
  
  <!-- Sticky Header -->
  <header class="bg-white border-b border-gray-200 px-6 py-4 flex-none z-30 shadow-sm">
    <div class="max-w-7xl mx-auto w-full">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-primary to-primary-light rounded-xl flex items-center justify-center shadow-md text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-900">Mode Editor</h1>
            <div id="client-url-wrapper" class="flex items-center gap-2 text-xs text-gray-500">
               <span class="uppercase tracking-wide font-semibold">Live URL:</span>
               <a id="client-url" class="text-primary hover:underline truncate max-w-[300px]"></a>
            </div>
          </div>
        </div>
        
        <div class="flex flex-wrap items-center gap-3">
            <button id="back-to-admin" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back
          </button>
          
          <a href="https://bcca.ai/flask/widget-demo.html" target="_blank" class="px-4 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 border border-blue-200">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            Embed
          </a>

          <div class="h-6 w-px bg-gray-300 mx-1"></div>

          <button id="mode-save" class="px-6 py-2 bg-gradient-to-r from-primary to-primary-light hover:from-primary-dark hover:to-primary text-white rounded-lg text-sm font-bold shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Save Changes
          </button>
          <div id="save-message" class="hidden absolute top-20 right-6 bg-green-100 border border-green-200 text-green-700 px-4 py-2 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2 z-50 animate-fade-in">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            Saved!
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Layout -->
  <div class="flex-1 flex overflow-hidden">
    
    <!-- Tab Navigation -->
    <div class="flex-1 flex flex-col min-w-0 bg-gray-50">
        
      <!-- Tabs Header -->
      <div class="bg-white border-b border-gray-200 px-6 pt-2">
        <div class="max-w-7xl mx-auto w-full flex space-x-6 overflow-x-auto no-scrollbar">
          <button class="tab-btn active px-2 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2" onclick="switchTab('settings')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            General Settings
          </button>
          <button class="tab-btn px-2 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2" onclick="switchTab('scraping')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            Web Scraper
          </button>
          <button id="tab-documents" class="tab-btn px-2 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2" onclick="switchTab('documents')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            Documents
          </button>
          <button class="tab-btn px-2 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2" onclick="switchTab('advanced')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path></svg>
            Advanced
          </button>
        </div>
      </div>

      <!-- Content Area -->
      <div class="flex-1 overflow-y-auto p-6">
        <div class="max-w-5xl mx-auto space-y-6 pb-20">
          
          <!-- SETTINGS TAB -->
          <div id="tab-content-settings" class="tab-content active space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Internal Mode Name</label>
                    <input id="mode-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm" placeholder="Unique ID (e.g. support-bot)" />
                    <p class="text-xs text-gray-400 mt-1">Used in API calls. Cannot be changed after creation.</p>
                 </div>
                 <div class="form-group">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Display Title</label>
                    <input id="mode-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm" placeholder="e.g. Customer Support" />
                 </div>
                 <div class="form-group md:col-span-2">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Description</label>
                    <textarea id="mode-desc" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm resize-y" placeholder="Internal description of what this mode does..."></textarea>
                 </div>
                 <div class="form-group md:col-span-2">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Welcome Message</label>
                    <textarea id="mode-intro" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm resize-y" placeholder="Hello! How can I help you today?"></textarea>
                    <p class="text-xs text-gray-400 mt-1">Shown to the user when they open the chat.</p>
                 </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Branding -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Branding & Colors</h2>
                    <div class="space-y-4">
                        <div class="flex items-center gap-4">
                            <div class="h-10 w-10 overflow-hidden rounded-lg border border-gray-200 shadow-sm relative">
                                <input id="mode-color" type="color" value="#82002d" class="absolute -top-2 -left-2 w-16 h-16 cursor-pointer p-0 border-0" />
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-900">Primary Color</label>
                                <p class="text-xs text-gray-500">Used for buttons, headers, and accents.</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="h-10 w-10 overflow-hidden rounded-lg border border-gray-200 shadow-sm relative">
                                <input id="mode-text-color" type="color" value="#ffffff" class="absolute -top-2 -left-2 w-16 h-16 cursor-pointer p-0 border-0" />
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-900">Button Text Color</label>
                                <p class="text-xs text-gray-500">Usually white or a light contrasting color.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prompts -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Prompts</h2>
                    <p class="text-xs text-gray-500 mb-3">Suggested questions displayed to help users start a conversation.</p>
                    <div class="bg-gray-50 rounded-xl border border-gray-200 p-4 min-h-[160px] flex flex-col cursor-text transition-colors focus-within:bg-white focus-within:ring-2 focus-within:ring-primary/10" onclick="document.getElementById('mode-prompt-input').focus()">
                        <div id="mode-prompts" class="flex flex-wrap gap-2 mb-3"></div>
                        <div class="relative mt-auto">
                            <input id="mode-prompt-input" class="w-full bg-transparent text-base text-gray-800 placeholder-gray-400 outline-none py-2 border-none ring-0 focus:ring-0" placeholder="Type a prompt and press Enter..." />
                            <div class="absolute right-0 top-2 text-xs text-gray-400 pointer-events-none font-medium flex items-center gap-1">
                                <span class="bg-gray-200 px-1.5 py-0.5 rounded text-[10px]">↵</span> Enter to add
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          </div>

          <!-- SCRAPING TAB -->
          <div id="tab-content-scraping" class="tab-content space-y-6">
            
            <!-- Scraper Config -->
            <div class="bg-white rounded-xl shadow-sm border border-blue-100 p-0 overflow-hidden">
                <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path></svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-blue-900">Website Scraping</h2>
                            <p class="text-sm text-blue-700">The scraper is the primary source of website data.</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Config Column -->
                    <div class="lg:col-span-1 space-y-6 border-r border-gray-100 pr-0 lg:pr-6">
                        <div class="space-y-4">
                            <label class="block text-sm font-medium text-gray-900">Target Sites</label>
                            <div class="flex gap-2">
                                <input id="scrape-site-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="https://example.com" />
                                <button id="add-scrape-site" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium">Add</button>
                            </div>
                            <div id="scrape-sites-list" class="space-y-2 max-h-40 overflow-y-auto bg-gray-50 rounded-lg p-2 border border-gray-200 min-h-[80px]"></div>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-gray-100">
                             <div>
                                <label class="block text-sm font-medium text-gray-900 mb-1">Frequency</label>
                                <select id="scrape-frequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                                    <option value="manual">Manual Only</option>
                                    <option value="daily">Daily (2 AM UTC)</option>
                                    <option value="weekly">Weekly (Sun 3 AM UTC)</option>
                                </select>
                             </div>
                             
                             <div class="flex items-center justify-between bg-blue-50 rounded-lg p-3 border border-blue-100">
                                <div class="text-xs text-blue-800">
                                    <span class="block opacity-75">Last Run:</span>
                                    <span id="last-scraped-at" class="font-medium">Never</span>
                                </div>
                                <button id="trigger-scrape-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded shadow-sm transition-colors flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    Run Now
                                </button>
                             </div>
                        </div>
                    </div>

                    <!-- Status & Results Column -->
                    <div class="lg:col-span-2 space-y-6">
                         <!-- Active Jobs -->
                         <div id="active-scrape-jobs-container" style="display:none;">
                            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span> Active Jobs
                            </h4>
                            <div id="scrape-queue-notice" class="hidden text-xs text-blue-600 bg-blue-50 p-2 rounded mb-2 border border-blue-100">
                                Queue is active. Jobs run in batches.
                            </div>
                            <div id="active-scrape-jobs-list" class="space-y-3"></div>
                         </div>

                         <!-- Content & Files Tabs (Nested) -->
                         <div class="border border-gray-200 rounded-xl overflow-hidden flex flex-col h-[650px]">
                             <div class="bg-gray-50 border-b border-gray-200 flex text-sm font-medium text-gray-600 flex-none">
                                 <button class="px-4 py-2 hover:bg-white hover:text-gray-900 border-r border-gray-200 flex-1 text-center bg-white text-blue-700" onclick="switchSubTab('scraped-pages', this)">Scraped Pages</button>
                                 <button class="px-4 py-2 hover:bg-white hover:text-gray-900 flex-1 text-center border-r border-gray-200" onclick="switchSubTab('discovered-files', this)">Discovered Files</button>
                                 <button id="refresh-scraped-content" class="px-3 py-2 hover:bg-white hover:text-blue-600 text-gray-500 transition-colors" title="Refresh Content">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                 </button>
                             </div>
                             
                             <div id="subtab-scraped-pages" class="p-0 bg-white overflow-y-auto flex-1 flex flex-col">
                                <div class="p-3 border-b border-gray-200 sticky top-0 bg-white z-10">
                                    <input type="text" id="filter-scraped-pages" placeholder="Search pages or sites..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                                </div>
                                <div id="scraped-sites-pages-combined" class="p-4 space-y-3 flex-1">
                                    <div class="text-center py-8 text-gray-400 text-sm">No content scraped yet.</div>
                                </div>
                             </div>
                             
                             <div id="subtab-discovered-files" class="p-0 bg-white hidden flex-col flex-1 h-full">
                                <div class="p-3 border-b border-gray-100 flex-none bg-white">
                                    <input type="text" id="filter-discovered-files" placeholder="Search files..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                                </div>
                                <div class="p-3 border-b border-gray-100 flex items-center justify-between bg-gray-50 flex-none">
                                    <label class="flex items-center gap-2 cursor-pointer select-none">
                                        <input type="checkbox" id="select-all-files" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                                        <span class="text-xs font-semibold text-gray-700">Select All</span>
                                    </label>
                                    <div class="flex gap-2">
                                        <button id="bulk-add-files" class="px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                            Add Selected
                                        </button>
                                        <button id="bulk-dismiss-files" class="px-3 py-1.5 bg-red-100 text-red-600 text-xs font-medium rounded hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                            Dismiss Selected
                                        </button>
                                    </div>
                                </div>
                                <div id="discovered-files-list" class="p-4 space-y-3 overflow-y-auto flex-1">
                                    <div class="text-center py-8 text-gray-400 text-sm">No files discovered yet.</div>
                                </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
          </div>

          <!-- DOCUMENTS TAB -->
          <div id="tab-content-documents" class="tab-content space-y-6">
             <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div id="docs-upload-area" class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center hover:border-primary hover:bg-pink-50 transition-colors cursor-pointer relative">
                    <input type="file" id="files" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                    <div class="pointer-events-none">
                        <svg class="w-10 h-10 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <p class="text-sm font-medium text-gray-900">Click or Drag to Upload Files</p>
                        <p class="text-xs text-gray-500 mt-1">PDF, DOCX, TXT, CSV supported</p>
                    </div>
                </div>
                
                <div id="file-rows" class="space-y-2 mt-4"></div>
                
                <div class="mt-4 flex justify-end">
                    <button id="upload" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-black transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Upload Selected Files
                    </button>
                </div>
             </div>

             <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 font-medium text-gray-700 text-sm">
                    Existing Documents
                </div>
                <ul id="doc-list" class="divide-y divide-gray-100">
                    <!-- Docs list items -->
                </ul>
             </div>
             
             <!-- Hidden ID for compatibility with existing JS logic that toggles docs-section -->
             <div id="docs-section" style="display:none"></div> 
          </div>

          <!-- ADVANCED TAB -->
          <div id="tab-content-advanced" class="tab-content space-y-6">
             <div class="bg-white rounded-xl shadow-sm border border-purple-100 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Search Priority
                </h2>
                <div class="space-y-3">
                     <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="radio" name="mode-priority-source" id="mode-priority-sites" value="sites" class="h-4 w-4 text-primary border-gray-300 focus:ring-primary" />
                        <div class="ml-3">
                            <span class="block text-sm font-medium text-gray-900">Scraped Content First</span>
                            <span class="block text-xs text-gray-500">Search scraped websites before checking uploaded files.</span>
                        </div>
                     </label>
                     <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="radio" name="mode-priority-source" id="mode-priority-files" value="files" class="h-4 w-4 text-primary border-gray-300 focus:ring-primary" />
                        <div class="ml-3">
                            <span class="block text-sm font-medium text-gray-900">Uploaded Files First</span>
                            <span class="block text-xs text-gray-500">Search documents before checking websites.</span>
                        </div>
                     </label>
                </div>
             </div>
             
             <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Configuration</h2>
                <div class="space-y-4">
                     <label class="flex items-center">
                        <input type="checkbox" id="mode-allow-other" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" />
                        <span class="ml-3 text-sm text-gray-700">Allow General Internet Search (fallback if no specific data found)</span>
                     </label>
                     <label class="flex items-center">
                        <input type="checkbox" id="mode-allow-upload" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" />
                        <span class="ml-3 text-sm text-gray-700">Allow Users to Upload Files in Chat</span>
                     </label>
                </div>
             </div>

             <!-- Blocked Sites moved here -->
             <div class="bg-white rounded-xl shadow-sm border border-red-100 p-0 overflow-hidden">
                <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-red-800">Blocked Sites</h3>
                        <p class="text-xs text-red-600">Excluded from search results</p>
                    </div>
                    <span id="blocked-count" class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded-full font-bold">0/30</span>
                </div>
                <div class="p-4 bg-white space-y-3">
                     <div class="flex gap-2">
                         <input id="blocked-site-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-red-500" placeholder="https://example.com" />
                         <button id="add-blocked-site" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">Add</button>
                     </div>
                     <div id="blocked-sites-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-1">
                        <!-- Items go here -->
                     </div>
                </div>
             </div>
             
             <div class="pt-6 border-t border-gray-200">
                 <button id="mode-delete" class="w-full py-3 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 rounded-xl text-sm font-bold transition-colors border border-red-200 flex justify-center items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Delete This Mode
                 </button>
             </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab Switching Logic
    function switchTab(tabId) {
       document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
       document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
       
       // Handle Document Tab specifically as it has a specific button ID in HTML
       if(tabId === 'documents') {
           document.getElementById('tab-documents').classList.add('active');
       } else {
           // Find button with onclick matching
           const buttons = Array.from(document.querySelectorAll('.tab-btn'));
           const btn = buttons.find(b => b.getAttribute('onclick').includes(tabId));
           if(btn) btn.classList.add('active');
       }
       
       document.getElementById('tab-content-' + tabId).classList.add('active');
    }

    function switchSubTab(subTabId, btn) {
        // Toggle Buttons
        btn.parentNode.querySelectorAll('button').forEach(b => {
            b.classList.remove('bg-white', 'text-blue-700');
            b.classList.add('hover:bg-white', 'hover:text-gray-900');
        });
        btn.classList.add('bg-white', 'text-blue-700');
        btn.classList.remove('hover:bg-white', 'hover:text-gray-900');
        
        // Toggle Content
        document.getElementById('subtab-scraped-pages').classList.remove('flex');
        document.getElementById('subtab-scraped-pages').classList.add('hidden');
        document.getElementById('subtab-discovered-files').classList.remove('flex');
        document.getElementById('subtab-discovered-files').classList.add('hidden');
        
        const target = document.getElementById('subtab-' + subTabId);
        target.classList.remove('hidden');
        if(subTabId === 'discovered-files') {
            target.classList.add('flex');
        } else {
             target.classList.add('block');
        }
    }

    /* -------------------------------------------------------------------------- */
    /*                         EXISTING FUNCTIONALITY MIGRATION                   */
    /* -------------------------------------------------------------------------- */
    
    const DEFAULT_THEME_COLOR = '#82002d';
    const DEFAULT_TEXT_COLOR = '#ffffff';

    function normalizeColor(value) {
      if (!value) return DEFAULT_THEME_COLOR;
      const text = String(value).trim();
      if (!text) return DEFAULT_THEME_COLOR;
      const prefixed = text.startsWith('#') ? text : `#${text}`;
      return /^#[0-9a-fA-F]{6}$/.test(prefixed) ? prefixed.toLowerCase() : DEFAULT_THEME_COLOR;
    }

    function normalizeTextColor(value) {
      if (!value) return DEFAULT_TEXT_COLOR;
      const text = String(value).trim();
      if (!text) return DEFAULT_TEXT_COLOR;
      const prefixed = text.startsWith('#') ? text : `#${text}`;
      return /^#[0-9a-fA-F]{6}$/.test(prefixed) ? prefixed.toLowerCase() : DEFAULT_TEXT_COLOR;
    }

    const idToken = localStorage.getItem('idToken') || '';
    
    function redirectToLogin() {
      window.location.href = '/flask/admin/login';
    }
    if (!idToken) {
      redirectToLogin();
    }

    function handleUnauthorized(res) {
      if (res && res.status === 401) {
        redirectToLogin();
        return true;
      }
      return false;
    }

    const params = new URLSearchParams(window.location.search);
    let modeId = params.get('id');
    let modeName = '';
    let modePrompts = [];
    // modePreferredSites removed
    let modeBlockedSites = [];
    let modeScrapeSites = [];
    const MAX_BLOCKED_SITES = 30;
    const colorInput = document.getElementById('mode-color');
    const textColorInput = document.getElementById('mode-text-color');
    colorInput.value = DEFAULT_THEME_COLOR;
    textColorInput.value = DEFAULT_TEXT_COLOR;

    async function loadMode() {
      if (!modeId) {
        renderModePrompts([]);
        renderBlockedSitesList([]);
        document.getElementById('mode-priority-sites').checked = true;
        document.getElementById('mode-priority-files').checked = false;
        document.getElementById('mode-allow-upload').checked = false;
        colorInput.value = DEFAULT_THEME_COLOR;
        textColorInput.value = DEFAULT_TEXT_COLOR;
        updateClientUrl();
        
        // Disable Docs and Scrape tabs for new mode
        const docTab = document.getElementById('tab-documents');
        if(docTab) {
            docTab.style.opacity = '0.5';
            docTab.style.pointerEvents = 'none';
            docTab.title = "Save mode first to manage documents";
        }
        return;
      }
      
      const res = await fetch('/flask/admin/modes/' + modeId, {
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res) || !res.ok) return;
      const m = await res.json();
      
      modeName = m.name || '';
      modePrompts = m.prompts || [];
      modeBlockedSites = m.blocked_sites || [];
      
      const nameInput = document.getElementById('mode-name');
      nameInput.value = m.name || '';
      nameInput.readOnly = true;
      nameInput.classList.add('bg-gray-100', 'text-gray-500');
      
      document.getElementById('mode-title').value = m.title || '';
      document.getElementById('mode-desc').value = m.description || '';
      document.getElementById('mode-intro').value = m.intro || '';
      
      colorInput.value = normalizeColor(m.color);
      textColorInput.value = normalizeTextColor(m.text_color);
      
      renderModePrompts(modePrompts);
      renderBlockedSitesList(modeBlockedSites);
      
      document.getElementById('mode-allow-other').checked = m.allow_other_sites !== false;
      const priority = (m.priority_source === 'files') ? 'files' : 'sites';
      document.getElementById('mode-priority-' + priority).checked = true;
      document.getElementById('mode-allow-upload').checked = !!m.allow_file_upload;
      
      // Enable Docs Tab
      const docTab = document.getElementById('tab-documents');
      if(docTab) {
            docTab.style.opacity = '1';
            docTab.style.pointerEvents = 'auto';
            docTab.title = "";
      }
      
      loadDocs();
      loadScrapedSites();
      loadScrapedContent(); 
      loadDiscoveredFiles();
      updateClientUrl();
      
      // Load scraping configuration
      modeScrapeSites = m.scrape_sites || [];
      renderScrapeSitesList();
      document.getElementById('scrape-frequency').value = m.scrape_frequency || 'manual';
      if (m.last_scraped_at) {
        const lastScraped = new Date(m.last_scraped_at);
        document.getElementById('last-scraped-at').textContent = lastScraped.toLocaleString();
      } else {
        document.getElementById('last-scraped-at').textContent = 'Never';
      }
    }

    document.getElementById('mode-save').onclick = async () => {
      const btn = document.getElementById('mode-save');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...';
      
      const body = {
        title: document.getElementById('mode-title').value,
        description: document.getElementById('mode-desc').value,
        intro: document.getElementById('mode-intro').value,
        prompts: Array.from(document.querySelectorAll('#mode-prompts .chip')).map(c => c.dataset.value),
        tags: [],
        preferred_sites: [], // Always empty
        blocked_sites: modeBlockedSites,
        allow_other_sites: document.getElementById('mode-allow-other').checked,
        priority_source: (document.querySelector('input[name="mode-priority-source"]:checked') || { value: 'sites' }).value,
        allow_file_upload: document.getElementById('mode-allow-upload').checked,
        scrape_sites: modeScrapeSites,
        scrape_frequency: document.getElementById('scrape-frequency').value,
        color: normalizeColor(colorInput.value),
        text_color: normalizeTextColor(textColorInput.value)
      };
      if (!modeId) {
        body.name = document.getElementById('mode-name').value;
      }
      
      try {
          const opts = {
            method: modeId ? 'PUT' : 'POST',
            headers: {
              'Authorization': 'Bearer ' + idToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          };
          const url = '/flask/admin/modes' + (modeId ? '/' + modeId : '');
          const res = await fetch(url, opts);
          if (handleUnauthorized(res)) {
            return;
          }
          if (res.ok) {
            const data = await res.json();
            if (!modeId) {
              window.location.href = '/flask/admin/mode?id=' + data._id;
            } else {
              loadMode();
              showSavedMessage();
            }
          } else {
             alert("Error saving mode.");
          }
      } catch(e) {
          console.error(e);
          alert("Error saving mode.");
      } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
      }
    };

    async function loadDocs() {
      if (!modeName) return;
      const res = await fetch('/flask/admin/documents?mode=' + encodeURIComponent(modeName), {
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res) || !res.ok) return;
      const data = await res.json();
      const list = document.getElementById('doc-list');
      list.innerHTML = '';
      if(data.documents.length === 0) {
          list.innerHTML = '<li class="p-4 text-center text-sm text-gray-400">No documents uploaded yet.</li>';
          return;
      }
      data.documents.forEach(doc => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-3 p-4 hover:bg-gray-50 transition-colors';
        
        // File info
        const infoContainer = document.createElement('div');
        infoContainer.className = 'flex-1 min-w-0 flex items-center gap-3';
        
        const icon = document.createElement('div');
        icon.className = 'w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500';
        icon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
        
        const textDiv = document.createElement('div');
        const label = document.createElement('span');
        label.className = 'text-sm text-gray-900 font-medium block truncate';
        label.textContent = doc.s3_key.split('/').pop();
        
        // Removed tag subLabel
        
        textDiv.appendChild(label);
        
        infoContainer.appendChild(icon);
        infoContainer.appendChild(textDiv);
        li.appendChild(infoContainer);
        
        // Buttons
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'flex gap-2 flex-shrink-0';
        
        // Download
        if (doc.s3_key) {
          const downloadBtn = document.createElement('a');
          downloadBtn.href = '/flask/admin/documents/' + doc._id + '/download';
          downloadBtn.className = 'text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors';
          downloadBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>';
          downloadBtn.title = "Download";
          downloadBtn.onclick = async (e) => {
            e.preventDefault();
            try {
              const res = await fetch(downloadBtn.href, {
                headers: { 'Authorization': 'Bearer ' + idToken }
              });
              if (handleUnauthorized(res)) return;
              if (!res.ok) {
                alert('Failed to download file');
                return;
              }
              const blob = await res.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = doc.s3_key.split('/').pop();
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            } catch (error) {
              console.error('Download failed:', error);
            }
          };
          buttonContainer.appendChild(downloadBtn);
        }
        
        // Delete
        const delBtn = document.createElement('button');
        delBtn.className = 'text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors';
        delBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
        delBtn.title = "Delete";
        delBtn.onclick = () => deleteDoc(doc._id);
        buttonContainer.appendChild(delBtn);
        
        li.appendChild(buttonContainer);
        list.appendChild(li);
      });
    }

    async function deleteDoc(id) {
      const res = await fetch('/flask/admin/documents/' + id, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res)) {
        return;
      }
      loadDocs();
    }

    // Scraped Sites and Content Logic (Combined)
    async function loadScrapedSitesAndPages() {
      if (!modeId) return;
      
      const [sitesRes, pagesRes] = await Promise.all([
        fetch('/flask/admin/scrape/sites/' + modeId, {
          headers: { 'Authorization': 'Bearer ' + idToken }
        }),
        fetch('/flask/admin/scrape/status/' + modeId, {
          headers: { 'Authorization': 'Bearer ' + idToken }
        })
      ]);
      
      if (handleUnauthorized(sitesRes) || handleUnauthorized(pagesRes)) return;
      if (!sitesRes.ok || !pagesRes.ok) return;
      
      const sitesData = await sitesRes.json();
      const pagesData = await pagesRes.json();
      
      const container = document.getElementById('scraped-sites-pages-combined');
      container.innerHTML = '';
      
      if (!sitesData.sites || sitesData.sites.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-400 text-center py-8">No sites scraped yet. Add URLs and click "Run Now".</div>';
        return;
      }
      
      const pagesByDomain = {};
      if (pagesData.scraped_content) {
        pagesData.scraped_content.forEach(page => {
          try {
            const url = new URL(page.url);
            const domain = url.hostname.replace(/^www\./, '');
            if (!pagesByDomain[domain]) {
              pagesByDomain[domain] = [];
            }
            pagesByDomain[domain].push(page);
          } catch (e) {
            console.error('Invalid URL:', page.url);
          }
        });
      }
      
      sitesData.sites.forEach(site => {
        const siteDiv = document.createElement('div');
        siteDiv.className = 'bg-white rounded-lg border border-gray-200 overflow-hidden mb-3 site-wrapper';
        siteDiv.dataset.domain = site.domain;
        
        const pages = pagesByDomain[site.domain] || [];
        
        siteDiv.innerHTML = `
          <div class="site-header p-3 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors flex items-center justify-between" data-domain="${site.domain}">
            <div class="flex items-center gap-3">
                 <svg class="expand-icon w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                 <div>
                    <div class="text-sm font-semibold text-gray-800">${site.domain}</div>
                    <div class="text-xs text-gray-500">${site.total_pages} pages • ${(site.total_words || 0).toLocaleString()} words</div>
                 </div>
            </div>
            <button class="delete-site-btn text-red-500 hover:text-red-700 hover:bg-red-50 p-1.5 rounded" data-domain="${site.domain}" onclick="event.stopPropagation()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
          <div class="pages-container hidden border-t border-gray-100" data-domain="${site.domain}">
            <div class="p-0">
              ${pages.length > 0 ? pages.map(page => `
                <div class="p-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 flex justify-between items-start gap-3 page-item" data-page-id="${page._id}">
                  <div class="min-w-0 flex-1">
                    <div class="text-sm font-medium text-blue-600 truncate cursor-pointer hover:underline search-target" onclick="window.open('${page.url}', '_blank')">${page.title || 'Untitled'}</div>
                    <div class="text-xs text-gray-400 truncate search-target">${page.url}</div>
                    <div class="text-xs text-gray-400 mt-1">${page.word_count || 0} words • ${page.scraped_at ? new Date(page.scraped_at).toLocaleDateString() : ''}</div>
                  </div>
                  <div class="flex gap-1">
                    <button class="refresh-btn text-blue-500 hover:bg-blue-50 p-1 rounded" data-id="${page._id}" title="Refresh"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                    <button class="delete-page-btn text-red-500 hover:bg-red-50 p-1 rounded" data-id="${page._id}" title="Delete"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                  </div>
                </div>
              `).join('') : '<div class="p-3 text-xs text-gray-400 text-center">No pages found</div>'}
            </div>
          </div>
        `;
        
        container.appendChild(siteDiv);
      });
      
      // Event Listeners for new elements
      document.querySelectorAll('.site-header').forEach(header => {
        header.addEventListener('click', () => {
          const domain = header.dataset.domain;
          const pagesContainer = document.querySelector(`.pages-container[data-domain="${domain}"]`);
          const expandIcon = header.querySelector('.expand-icon');
          
          if (pagesContainer.classList.contains('hidden')) {
            pagesContainer.classList.remove('hidden');
            expandIcon.style.transform = 'rotate(90deg)';
          } else {
            pagesContainer.classList.add('hidden');
            expandIcon.style.transform = 'rotate(0deg)';
          }
        });
      });
      
      document.querySelectorAll('.delete-site-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          deleteSiteContent(btn.dataset.domain);
        };
      });
      
      document.querySelectorAll('.refresh-btn').forEach(btn => {
        btn.onclick = () => refreshScrapedContent(btn.dataset.id);
      });
      document.querySelectorAll('.delete-page-btn').forEach(btn => {
        btn.onclick = () => deleteScrapedContent(btn.dataset.id);
      });

      // Apply filter if exists
      applyScrapedPageFilter();
    }

    async function loadScrapedSites() {
      return loadScrapedSitesAndPages();
    }
    
    async function loadScrapedContent() { return; }

    async function deleteSiteContent(domain) {
      if (!confirm(`Delete ALL content from ${domain}?`)) return;
      
      const siteWrapper = document.querySelector(`.site-wrapper[data-domain="${domain}"]`);
      if (siteWrapper) {
          siteWrapper.classList.add('deleting-active', 'opacity-75', 'pointer-events-none');
          const btn = siteWrapper.querySelector('.delete-site-btn');
          if (btn) {
               btn.innerHTML = `<svg class="w-4 h-4 text-red-500 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>`;
          }
          const titleDiv = siteWrapper.querySelector('.site-header .text-sm');
          if (titleDiv && !titleDiv.querySelector('.deleting-badge')) {
               const badge = document.createElement('span');
               badge.className = 'deleting-badge ml-2 text-xs text-red-600 font-medium';
               badge.innerText = 'Deleting...';
               titleDiv.appendChild(badge);
          }
      }

      const res = await fetch(`/flask/admin/scrape/site/${modeId}/${encodeURIComponent(domain)}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (!handleUnauthorized(res) && res.ok) {
        loadActiveScrapingJobs();
      } else {
         alert('Error deleting site content');
         loadScrapedSitesAndPages(); // Reload to restore UI
      }
    }

    async function refreshScrapedContent(contentId) {
      const res = await fetch('/flask/admin/scrape/refresh/' + contentId, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (!handleUnauthorized(res) && res.ok) {
        loadScrapedSitesAndPages();
      }
    }

    async function deleteScrapedContent(contentId) {
      if (!confirm('Delete this page?')) return;
      const res = await fetch('/flask/admin/scraped-content/' + contentId, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (!handleUnauthorized(res) && res.ok) {
        loadScrapedSitesAndPages();
      }
    }

    // Discovered Files
    function getDiscoveredFileDownloadUrl(file) {
      return file.file_url || file.download_url || file.fileUrl || file.source_file_url || file.embed_page_url || file.source_page_url || '';
    }
    
    async function loadDiscoveredFiles() {
      if (!modeId) return;
      const res = await fetch('/flask/admin/scrape/discovered-files/' + modeId, {
        headers: { 'Authorization': 'Bearer ' + idToken }
      });
      if (handleUnauthorized(res) || !res.ok) return;
      const data = await res.json();
      const list = document.getElementById('discovered-files-list');
      list.innerHTML = '';
      
      if (!data.files || data.files.length === 0) {
        list.innerHTML = '<div class="text-sm text-gray-400 text-center py-8">No discovered files found.</div>';
        updateBulkButtons();
        return;
      }
      
      data.files.forEach(file => {
          const div = document.createElement('div');
          div.className = 'p-3 bg-gray-50 rounded border border-gray-200 flex items-start gap-3 discovered-file-entry group hover:bg-white hover:border-blue-200 transition-colors cursor-pointer';
          div.dataset.fileId = file._id;
          
          // Clicking row toggles checkbox (unless clicking buttons/links)
          div.onclick = (e) => {
              if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A' && e.target.type !== 'checkbox') {
                  const cb = div.querySelector('input[type="checkbox"]');
                  cb.checked = !cb.checked;
                  updateBulkButtons();
              }
          };

          div.innerHTML = `
            <div class="flex items-center h-full pt-1">
                <input type="checkbox" class="file-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4 cursor-pointer" data-file-id="${file._id}">
            </div>
            <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                    <span class="px-2 py-0.5 rounded text-[11px] font-bold bg-gray-200 text-gray-700 uppercase">${file.file_extension}</span>
                    <span class="text-sm font-medium text-gray-900 truncate" title="${file.filename}">${file.filename}</span>
                </div>
                <div class="text-xs text-gray-500 mt-1 truncate" title="${file.source_page_url}">From: ${file.source_page_title || file.source_page_url}</div>
            </div>
            <div class="flex gap-2 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="add-file-btn text-xs bg-white border border-gray-200 text-green-600 px-2 py-1 rounded hover:bg-green-50 transition-colors" data-file-id="${file._id}">Add</button>
                <button class="remove-file-btn text-xs bg-white border border-gray-200 text-red-600 px-2 py-1 rounded hover:bg-red-50 transition-colors" data-file-id="${file._id}">Dismiss</button>
            </div>
          `;
          list.appendChild(div);
      });
      
      // Checkbox listeners
      document.querySelectorAll('.file-checkbox').forEach(cb => {
          cb.onclick = (e) => {
              e.stopPropagation(); // Prevent row click bubbling
              updateBulkButtons();
          };
      });

      // Re-attach listeners
      document.querySelectorAll('.add-file-btn').forEach(btn => btn.onclick = (e) => {
          e.stopPropagation();
          addDiscoveredFile(btn.dataset.fileId);
      });
      document.querySelectorAll('.remove-file-btn').forEach(btn => btn.onclick = (e) => {
          e.stopPropagation();
          removeDiscoveredFile(btn.dataset.fileId);
      });
      
      updateBulkButtons();
      applyDiscoveredFileFilter();
    }
    
    // Bulk Operations Logic
    const selectAllCb = document.getElementById('select-all-files');
    selectAllCb.onclick = () => {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAllCb.checked);
        updateBulkButtons();
    };
    
    function updateBulkButtons() {
        const checkedCount = document.querySelectorAll('.file-checkbox:checked').length;
        const totalCount = document.querySelectorAll('.file-checkbox').length;
        
        document.getElementById('bulk-add-files').disabled = checkedCount === 0;
        document.getElementById('bulk-dismiss-files').disabled = checkedCount === 0;
        document.getElementById('bulk-add-files').textContent = checkedCount > 0 ? `Add (${checkedCount})` : 'Add Selected';
        document.getElementById('bulk-dismiss-files').textContent = checkedCount > 0 ? `Dismiss (${checkedCount})` : 'Dismiss Selected';
        
        // Update Select All state
        if (totalCount > 0 && checkedCount === totalCount) {
            selectAllCb.checked = true;
            selectAllCb.indeterminate = false;
        } else if (checkedCount > 0) {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = true;
        } else {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = false;
        }
    }

    document.getElementById('bulk-add-files').onclick = async () => {
        const selected = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.dataset.fileId);
        if (selected.length === 0) return;
        
        const btn = document.getElementById('bulk-add-files');
        btn.disabled = true;
        btn.textContent = 'Adding...';
        
        for (const fileId of selected) {
            await fetch('/flask/admin/scrape/add-file/' + modeId, {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + idToken, 'Content-Type': 'application/json' },
              body: JSON.stringify({ file_id: fileId, tag: '' })
            });
        }
        
        loadDiscoveredFiles();
        loadDocs();
    };

    document.getElementById('bulk-dismiss-files').onclick = async () => {
        const selected = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.dataset.fileId);
        if (selected.length === 0) return;
        if (!confirm(`Dismiss ${selected.length} files?`)) return;
        
        const btn = document.getElementById('bulk-dismiss-files');
        btn.disabled = true;
        btn.textContent = 'Dismissing...';
        
        for (const fileId of selected) {
            await fetch('/flask/admin/scrape/discovered-file/' + fileId, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + idToken }
            });
        }
        
        loadDiscoveredFiles();
    };

    async function addDiscoveredFile(fileId) {
        const res = await fetch('/flask/admin/scrape/add-file/' + modeId, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + idToken, 'Content-Type': 'application/json' },
          body: JSON.stringify({ file_id: fileId, tag: '' })
        });
        if (!handleUnauthorized(res) && res.ok) {
            loadDiscoveredFiles();
            loadDocs();
        } else {
            alert('Failed to add file.');
        }
    }
    
    async function removeDiscoveredFile(fileId) {
        if(!confirm("Dismiss this file?")) return;
        const res = await fetch('/flask/admin/scrape/discovered-file/' + fileId, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + idToken }
        });
        if (!handleUnauthorized(res) && res.ok) {
            loadDiscoveredFiles();
        }
    }

    // Active Jobs
    async function loadActiveScrapingJobs() {
      if (!modeId) return;
      try {
        const res = await fetch('/flask/admin/scrape/active-jobs/' + modeId, { headers: { 'Authorization': 'Bearer ' + idToken } });
        if (handleUnauthorized(res) || !res.ok) return;
        const data = await res.json();
        const jobs = data.jobs || [];
        const container = document.getElementById('active-scrape-jobs-container');
        const list = document.getElementById('active-scrape-jobs-list');
        const queueNotice = document.getElementById('scrape-queue-notice');
        
        // Track deleting domains to update UI
        const deletingDomains = new Set();
        // Track running scrape jobs to update site list
        const runningScrapes = new Map();

        jobs.forEach(j => {
            if (j.job_type === 'site_delete' && j.domain) deletingDomains.add(j.domain);
            if (j.job_type === 'scrape') {
                const sites = j.progress.total_sites || 1;
                const currentSiteIndex = j.progress.current_site || 0;
                // We don't get the exact domain being scraped in the top-level progress easily 
                // unless we enhance the backend or infer it.
                // But we can check if we have sites in the list that match configured sites.
                runningScrapes.set(j._id, j);
            }
        });
        updateSiteDeleteIndicators(deletingDomains);
        updateRunningScrapeIndicators(runningScrapes);
        
        if (jobs.length === 0) {
          container.style.display = 'none';
          if (queueNotice) queueNotice.style.display = 'none';
          return;
        }
        
        container.style.display = 'block';
        list.innerHTML = '';
        if (queueNotice) queueNotice.style.display = jobs.some(j => j.status === 'queued') ? 'block' : 'none';
        
        jobs.forEach(job => {
           // Skip delete jobs in the main list to reduce clutter, or show them?
           // User wants to see jobs. Let's show them.
           const jobDiv = document.createElement('div');
           jobDiv.className = 'bg-blue-50 rounded border border-blue-200 p-3 text-sm';
           const progress = job.progress || {};
           
           let title = `Job #${job._id.slice(-6)}`;
           let statusText = job.status === 'queued' ? 'Queued...' : 'In Progress';
           
           if (job.job_type === 'site_delete') {
               title = `Deleting ${job.domain}`;
               statusText = job.status === 'queued' ? 'Queued...' : `Deleting... (${progress.current || 0}/${progress.total || '?'})`;
           } else if (job.job_type === 'scrape') {
               statusText = job.status === 'queued' ? 'Queued...' : `${progress.scraped_pages || 0} pages scraped`;
           }
           
           jobDiv.innerHTML = `
             <div class="flex justify-between items-center mb-1">
                <span class="font-bold text-blue-900">${title}</span>
                <span class="text-xs bg-blue-200 text-blue-800 px-1.5 py-0.5 rounded uppercase">${job.status}</span>
             </div>
             <div class="text-xs text-blue-700">${statusText}</div>
             <div class="h-1 bg-blue-200 mt-2 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500 animate-pulse w-full"></div>
             </div>
           `;
           list.appendChild(jobDiv);
        });
      } catch (e) { console.error(e); }
    }

    function updateRunningScrapeIndicators(runningScrapes) {
        // If we have running scrapes, we want to make sure the sites are visible in the list
        // and show some progress.
        // Since we don't know EXACTLY which site is being scraped right now without more data from backend,
        // we can iterate through the configured sites and see if they are in the scraped list.
        // If not, add them as placeholders.
        
        // This is tricky because "modeScrapeSites" has the configured URLs.
        if (runningScrapes.size > 0) {
            const container = document.getElementById('scraped-sites-pages-combined');
            
            // Check if we need to add placeholders
            modeScrapeSites.forEach(url => {
                let domain;
                try {
                    domain = new URL(url).hostname.replace(/^www\./, '');
                } catch(e) { return; }
                
                let wrapper = document.querySelector(`.site-wrapper[data-domain="${domain}"]`);
                if (!wrapper) {
                    // Create placeholder wrapper
                    wrapper = document.createElement('div');
                    wrapper.className = 'bg-white rounded-lg border border-gray-200 overflow-hidden mb-3 site-wrapper';
                    wrapper.dataset.domain = domain;
                    wrapper.innerHTML = `
                      <div class="site-header p-3 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors flex items-center justify-between" data-domain="${domain}">
                        <div class="flex items-center gap-3">
                             <svg class="expand-icon w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                             <div>
                                <div class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                                    ${domain}
                                    <span class="text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded">Scraping...</span>
                                </div>
                                <div class="text-xs text-gray-500 progress-text">Initializing...</div>
                             </div>
                        </div>
                        <button class="delete-site-btn text-red-500 hover:text-red-700 hover:bg-red-50 p-1.5 rounded" data-domain="${domain}" onclick="event.stopPropagation()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                      </div>
                      <div class="pages-container hidden border-t border-gray-100" data-domain="${domain}">
                        <div class="p-3 text-xs text-gray-400 text-center">Content will appear here as it is scraped.</div>
                      </div>
                    `;
                    
                    // Add to top or bottom? Top seems better for active things.
                    container.insertBefore(wrapper, container.firstChild);
                    
                    // Attach listeners
                    wrapper.querySelector('.site-header').addEventListener('click', () => {
                      const pagesContainer = wrapper.querySelector(`.pages-container`);
                      const expandIcon = wrapper.querySelector('.expand-icon');
                      if (pagesContainer.classList.contains('hidden')) {
                        pagesContainer.classList.remove('hidden');
                        expandIcon.style.transform = 'rotate(90deg)';
                      } else {
                        pagesContainer.classList.add('hidden');
                        expandIcon.style.transform = 'rotate(0deg)';
                      }
                    });
                    
                    wrapper.querySelector('.delete-site-btn').onclick = (e) => {
                      e.stopPropagation();
                      deleteSiteContent(domain);
                    };
                } else {
                    // Update existing wrapper if it exists but doesn't have status
                    const statusSpan = wrapper.querySelector('.site-header .text-xs.bg-blue-100');
                    if (!statusSpan) {
                         const titleDiv = wrapper.querySelector('.site-header .font-semibold');
                         if(titleDiv) {
                             const span = document.createElement('span');
                             span.className = 'text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded ml-2';
                             span.innerText = 'Scraping...';
                             titleDiv.appendChild(span);
                         }
                    }
                }
                
                // Try to update progress text if we can map it?
                // For now, just showing "Scraping..." is a good first step.
            });
        } else {
             // Cleanup "Scraping..." badges if no jobs running
             document.querySelectorAll('.site-wrapper .text-xs.bg-blue-100').forEach(el => el.remove());
        }
    }

    function updateSiteDeleteIndicators(deletingDomains) {
        document.querySelectorAll('.site-wrapper').forEach(wrapper => {
            const domain = wrapper.dataset.domain;
            const isDeleting = deletingDomains.has(domain);
            const hasIndicator = wrapper.classList.contains('deleting-active');
            
            if (isDeleting) {
                if (!hasIndicator) {
                     wrapper.classList.add('deleting-active', 'opacity-75', 'pointer-events-none');
                     const btn = wrapper.querySelector('.delete-site-btn');
                     if (btn) {
                        btn.innerHTML = `<svg class="w-4 h-4 text-red-500 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>`;
                     }
                     const titleDiv = wrapper.querySelector('.site-header .text-sm');
                     if (titleDiv && !titleDiv.querySelector('.deleting-badge')) {
                         const badge = document.createElement('span');
                         badge.className = 'deleting-badge ml-2 text-xs text-red-600 font-medium';
                         badge.innerText = 'Deleting...';
                         titleDiv.appendChild(badge);
                     }
                }
            } else {
                 if (hasIndicator) {
                     // Job finished, refresh list
                     loadScrapedSitesAndPages();
                     loadDiscoveredFiles();
                 }
            }
        });
    }

    // Polling logic for jobs
    let activeJobsListPollInterval = setInterval(loadActiveScrapingJobs, 3000);
    
    document.getElementById('trigger-scrape-btn').onclick = async () => {
       if (!modeId) return alert('Save mode first.');
       
       // Force a save first if there are pending changes (basic check)
       if (document.getElementById('scrape-site-input').value.trim() !== '') {
           if (!confirm("You have an unsaved site in the input. It will not be included. Continue?")) return;
       }
       
       // Better: Check if the displayed sites match what we think is saved? 
       // For now, just rely on user saving. 
       // OR: trigger a save first?
       // Let's trigger a save first to ensure latest config is used.
       const saveBtn = document.getElementById('mode-save');
       if (!saveBtn.disabled) {
            // Trigger save
            await saveBtn.click();
            // Wait a moment for save to complete - the save button handler is async but doesn't return a promise we can await easily here without refactoring.
            // Actually, let's just use the fact that modeScrapeSites is updated in memory, 
            // but the backend needs the DB updated. 
            // The existing save handler updates the DB.
            // We can manually call the API update here if we want to be sure, OR refactor save to be reusable.
            
            // Refactoring save logic slightly to allow awaiting it would be best, but for this fix:
            // We'll just manually send the update for sites if needed, or just warn the user.
            
            // Simplest fix for the reported issue: "URLs added, but not yet saved"
            // The user added to the list UI, but didn't click Save.
            // We should auto-save the sites before triggering.
            
            const body = {
                scrape_sites: modeScrapeSites,
                // We need to send other required fields or use PATCH if supported.
                // The main save uses PUT/POST with all fields.
                // Let's just block if not saved? No, the user wants "Run Now" to just work.
                // Let's do a quick PATCH or re-save.
            };
            
            // To be safe and consistent, let's just call the save endpoint with current state before triggering.
            // We duplicate the save logic payload construction here or refactor. 
            // Let's duplicate strictly necessary parts for a "quick save" of sites.
            
            // Actually, the easiest path is to just tell the user to save if we detect changes?
            // But the requirement says "If I click Run Now... returns 400".
            // The 400 comes from: if not scrape_sites: return 400.
            // So the DB has no sites.
            
            // We MUST save the sites to the DB before triggering.
            const fullBody = {
                title: document.getElementById('mode-title').value,
                description: document.getElementById('mode-desc').value,
                intro: document.getElementById('mode-intro').value,
                prompts: modePrompts,
                tags: [],
                preferred_sites: [],
                blocked_sites: modeBlockedSites,
                allow_other_sites: document.getElementById('mode-allow-other').checked,
                priority_source: (document.querySelector('input[name="mode-priority-source"]:checked') || { value: 'sites' }).value,
                allow_file_upload: document.getElementById('mode-allow-upload').checked,
                scrape_sites: modeScrapeSites, // This is the key part
                scrape_frequency: document.getElementById('scrape-frequency').value,
                color: normalizeColor(document.getElementById('mode-color').value),
                text_color: normalizeTextColor(document.getElementById('mode-text-color').value)
            };
             if (!modeId) fullBody.name = document.getElementById('mode-name').value;
             
             // Silent Save
             try {
                await fetch('/flask/admin/modes/' + modeId, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + idToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify(fullBody)
                });
             } catch(e) { console.error("Auto-save failed", e); }
       }
       
       const btn = document.getElementById('trigger-scrape-btn');
       btn.disabled = true; 
       btn.innerText = 'Starting...';
       
       const res = await fetch('/flask/admin/scrape/trigger/' + modeId, { method: 'POST', headers: { 'Authorization': 'Bearer ' + idToken } });
       if (!handleUnauthorized(res) && res.ok) {
           loadActiveScrapingJobs();
           document.getElementById('last-scraped-at').textContent = new Date().toLocaleString();
       } else {
           const err = await res.json();
           alert('Failed to start scrape: ' + (err.error || 'Unknown error'));
       }
       btn.disabled = false;
       btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Run Now';
    };

    // File Upload (Direct)
    document.getElementById('upload').onclick = async () => {
       const rows = document.querySelectorAll('#file-rows .file-row');
       if(rows.length === 0) return alert("No files selected.");
       
       const btn = document.getElementById('upload');
       btn.disabled = true;
       btn.innerText = "Uploading...";
       
       try {
           for (const row of rows) {
                const file = row.file;
                const form = new FormData();
                form.append('mode', modeName);
                form.append('tag', ''); 
                form.append('content', '');
                form.append('file', file);
                await fetch('/flask/admin/documents', {
                  method: 'POST',
                  headers: { 'Authorization': 'Bearer ' + idToken },
                  body: form
                });
           }
           document.getElementById('files').value = '';
           document.getElementById('file-rows').innerHTML = '';
           loadDocs();
       } catch(e) {
           alert("Error uploading files.");
       } finally {
           btn.disabled = false;
           btn.innerText = "Upload Selected Files";
       }
    };
    
    // File Selection Handling
    document.getElementById('files').addEventListener('change', function() {
        const container = document.getElementById('file-rows');
        container.innerHTML = '';
        Array.from(this.files).forEach(file => {
            const row = document.createElement('div');
            row.className = 'file-row flex items-center justify-between p-2 bg-gray-50 border border-gray-200 rounded text-sm';
            row.file = file;
            row.innerHTML = `<span class="truncate font-medium">${file.name}</span> <span class="text-xs text-gray-500">${(file.size/1024).toFixed(1)} KB</span>`;
            container.appendChild(row);
        });
    });

    function renderModePrompts(prompts) {
        const container = document.getElementById('mode-prompts');
        container.innerHTML = '';
        const input = document.getElementById('mode-prompt-input');
        
        modePrompts = [...(prompts || [])];
        modePrompts.forEach(p => {
            container.appendChild(createChip(p, modePrompts, 'bg-primary'));
        });
    }

    function createChip(text, arrayRef, colorClass) {
        const chip = document.createElement('span');
        chip.className = `chip inline-flex items-center ${colorClass} text-white rounded-lg px-3 py-1.5 text-sm shadow-sm transition-all hover:shadow-md mr-2 mb-1 animate-fade-in`;
        chip.dataset.value = text;
        chip.innerHTML = `<span class="mr-2">${text}</span>`;
        
        const btn = document.createElement('button');
        btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        btn.className = 'hover:text-red-200 focus:outline-none opacity-75 hover:opacity-100 transition-opacity';
        btn.onclick = (e) => {
             e.preventDefault();
             e.stopPropagation(); // Prevent focusing input if chip is clicked
             const idx = arrayRef.indexOf(text);
             if (idx > -1) arrayRef.splice(idx, 1);
             chip.remove();
        };
        chip.appendChild(btn);
        return chip;
    }

    document.getElementById('mode-prompt-input').addEventListener('keydown', e => {
        if(e.key === 'Enter' && e.target.value.trim()) {
            e.preventDefault();
            modePrompts.push(e.target.value.trim());
            renderModePrompts(modePrompts);
            e.target.value = '';
        }
    });

    // Blocked Sites List Logic (Replaces generic logic)
    function renderBlockedSitesList(blocked) {
        modeBlockedSites = [...(blocked || [])];
        const container = document.getElementById('blocked-sites-list');
        container.innerHTML = '';
        modeBlockedSites.forEach((site, index) => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-2 bg-gray-50 border border-gray-100 rounded group hover:bg-gray-100 transition-colors cursor-move';
            item.draggable = true;
            item.dataset.index = index;
            
            // Drag Events
            item.addEventListener('dragstart', (e) => handleDragStart(e, item, 'blocked'));
            item.addEventListener('dragend', (e) => handleDragEnd(e, item));
            item.addEventListener('dragover', (e) => handleDragOver(e));
            item.addEventListener('drop', (e) => handleDrop(e, item, 'blocked'));

            item.innerHTML = `
                <div class="flex items-center gap-2 overflow-hidden">
                    <svg class="w-4 h-4 text-gray-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                    <span class="text-sm text-gray-700 truncate">${site}</span>
                </div>
                <button class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="removeBlockedSite(${index})">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            container.appendChild(item);
        });
        document.getElementById('blocked-count').innerText = `${modeBlockedSites.length}/${MAX_BLOCKED_SITES}`;
    }

    // Drag and Drop Helpers
    let draggedElement = null;
    let draggedType = null;

    function clearAllDropIndicators() {
        document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
    }

    function handleDragStart(e, element, type) {
        clearAllDropIndicators();
        draggedElement = element;
        draggedType = type;
        element.classList.add('opacity-50');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', element.outerHTML);
    }

    function handleDragEnd(e, element) {
        element.classList.remove('opacity-50');
        clearAllDropIndicators();
        draggedElement = null;
        draggedType = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const container = e.currentTarget.parentNode;
        clearAllDropIndicators();
        
        const afterElement = getDragAfterElement(container, e.clientY);
        const indicator = document.createElement('div');
        indicator.className = 'drop-indicator h-0.5 bg-primary my-1 rounded';
        
        if (afterElement == null) {
            container.appendChild(indicator);
        } else {
            container.insertBefore(indicator, afterElement);
        }
    }

    function handleDrop(e, element, type) {
        e.preventDefault();
        if (draggedType !== type) return;
        
        const container = e.currentTarget.parentNode;
        const afterElement = getDragAfterElement(container, e.clientY);
        const dragging = draggedElement;
        
        if (afterElement == null) {
            container.appendChild(dragging);
        } else {
            container.insertBefore(dragging, afterElement);
        }
        
        // Re-order array based on DOM order
        const items = Array.from(container.querySelectorAll('[draggable="true"]'));
        const newOrder = items.map(item => {
            const index = parseInt(item.dataset.index);
            return modeBlockedSites[index];
        });
        
        modeBlockedSites = newOrder;
        renderBlockedSitesList(modeBlockedSites); // Re-render to update indices
        clearAllDropIndicators();
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.opacity-50)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function removeBlockedSite(index) {
        modeBlockedSites.splice(index, 1);
        renderBlockedSitesList(modeBlockedSites);
    }

    document.getElementById('add-blocked-site').onclick = () => {
        const input = document.getElementById('blocked-site-input');
        const val = input.value.trim();
        if(!val) return;
        
        if(modeBlockedSites.length >= MAX_BLOCKED_SITES) return alert('Limit reached');
        modeBlockedSites.push(val);
        renderBlockedSitesList(modeBlockedSites);
        input.value = '';
    };
    
    // Scrape Sites List
    function renderScrapeSitesList() {
        const container = document.getElementById('scrape-sites-list');
        container.innerHTML = '';
        if(modeScrapeSites.length === 0) container.innerHTML = '<div class="text-xs text-gray-400 text-center py-2">No sites added.</div>';
        
        modeScrapeSites.forEach((site, index) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 bg-white border border-gray-200 rounded text-sm';
            div.innerHTML = `
                <span class="truncate text-gray-600">${site}</span>
                <button class="text-red-400 hover:text-red-600" onclick="removeScrapeSite(${index})">&times;</button>
            `;
            container.appendChild(div);
        });
    }

    function removeScrapeSite(index) {
        modeScrapeSites.splice(index, 1);
        renderScrapeSitesList();
        autoSaveScrapeSites();
    }

    document.getElementById('add-scrape-site').onclick = () => {
        const input = document.getElementById('scrape-site-input');
        const val = input.value.trim();
        if(!val) return;
        if(modeScrapeSites.includes(val)) return alert('Already added.');
        modeScrapeSites.push(val);
        input.value = '';
        renderScrapeSitesList();
        autoSaveScrapeSites();
    };

    async function autoSaveScrapeSites() {
        if(!modeId) return;
        // Silent save logic could be added here if desired, 
        // essentially triggering the Save function but without the loading overlay
    }

    document.getElementById('mode-delete').onclick = async () => {
        if(!modeId) return;
        if(!confirm("Permanently delete this mode and all its data?")) return;
        if(!confirm("Are you absolutely sure?")) return;
        
        const res = await fetch('/flask/admin/modes/' + modeId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + idToken } });
        if(!handleUnauthorized(res) && res.ok) {
            window.location.href = '/flask/admin';
        } else {
            alert("Error deleting mode.");
        }
    };

    function updateClientUrl() {
        const nameValue = document.getElementById('mode-name').value.trim();
        const link = document.getElementById('client-url');
        if(!link) return;
        if(!nameValue) {
            link.textContent = '—';
            link.removeAttribute('href');
            return;
        }
        const url = 'https://bcca.ai/flask/?mode=' + encodeURIComponent(nameValue);
        link.textContent = url;
        link.href = url;
        link.target = '_blank';
    }
    
    document.getElementById('mode-name').addEventListener('input', updateClientUrl);
    document.getElementById('back-to-admin').onclick = () => window.location.href = '/flask/admin';

    function showSavedMessage() {
        const msg = document.getElementById('save-message');
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 2000);
    }

    // Auto-expand textarea functionality
    function autoExpandTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.max(textarea.scrollHeight, 80) + 'px';
    }

    function setupAutoExpand() {
      const descTextarea = document.getElementById('mode-desc');
      const introTextarea = document.getElementById('mode-intro');
      
      if (descTextarea) {
        descTextarea.addEventListener('input', () => autoExpandTextarea(descTextarea));
        setTimeout(() => autoExpandTextarea(descTextarea), 100);
      }
      
      if (introTextarea) {
        introTextarea.addEventListener('input', () => autoExpandTextarea(introTextarea));
        setTimeout(() => autoExpandTextarea(introTextarea), 100);
      }
    }

    // Init
    loadMode();
    setupAutoExpand();

    // --------------------------------------------------------------------------
    // Search / Filter Logic
    // --------------------------------------------------------------------------

    function applyScrapedPageFilter() {
        const input = document.getElementById('filter-scraped-pages');
        if (!input) return;
        const query = input.value.toLowerCase().trim();
        
        const siteWrappers = document.querySelectorAll('.site-wrapper');
        
        siteWrappers.forEach(wrapper => {
            const domain = wrapper.dataset.domain.toLowerCase();
            const pagesContainer = wrapper.querySelector('.pages-container');
            const items = pagesContainer.querySelectorAll('.page-item');
            
            let hasVisiblePages = false;
            let domainMatches = domain.includes(query);
            
            items.forEach(item => {
                // If domain matches, show all pages? Or filter pages too?
                // Let's filter pages regardless, but if domain matches, maybe we show pages even if they don't match?
                // Usually "filter" means filter the list. If I search "example", I want pages with "example" OR site "example".
                // If site matches "example", showing all pages is reasonable.
                
                const targets = item.querySelectorAll('.search-target');
                let match = false;
                targets.forEach(t => {
                    if (t.innerText.toLowerCase().includes(query)) match = true;
                });
                
                if (query === '' || match || domainMatches) {
                    item.style.display = '';
                    hasVisiblePages = true;
                } else {
                    item.style.display = 'none';
                }
            });

            if (hasVisiblePages) {
                wrapper.style.display = '';
                // Auto-expand if searching and matches found (and not empty query)
                if (query !== '') {
                    pagesContainer.classList.remove('hidden');
                    const icon = wrapper.querySelector('.expand-icon');
                    if (icon) icon.style.transform = 'rotate(90deg)';
                }
            } else {
                wrapper.style.display = 'none';
            }
        });
    }

    function applyDiscoveredFileFilter() {
        const input = document.getElementById('filter-discovered-files');
        if (!input) return;
        const query = input.value.toLowerCase().trim();
        
        const items = document.querySelectorAll('.discovered-file-entry');
        items.forEach(item => {
            // Text to search: filename, extension, source
            const text = item.innerText.toLowerCase();
            if (text.includes(query)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    document.getElementById('filter-scraped-pages').addEventListener('input', applyScrapedPageFilter);
    document.getElementById('filter-discovered-files').addEventListener('input', applyDiscoveredFileFilter);

    // Refresh Button Logic
    document.getElementById('refresh-scraped-content').onclick = () => {
        const btn = document.getElementById('refresh-scraped-content');
        btn.firstElementChild.classList.add('animate-spin');
        Promise.all([loadScrapedSitesAndPages(), loadDiscoveredFiles()]).then(() => {
            setTimeout(() => btn.firstElementChild.classList.remove('animate-spin'), 500);
        });
    };

  </script>
</body>
</html>
